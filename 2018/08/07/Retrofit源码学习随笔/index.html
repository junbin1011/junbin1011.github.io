<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,源码," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Retrofit是什么？简介Retrofit，中文的翻译为“式样翻新”的意思，是一个基于OKHttp的RESTful网络请求框架。通俗一点来说，Retrofit就是一个网络请求框架的封装。同样是由Square公司开源的Android热门网络框架之一，其具有功能强大、简洁易用及高可拓展性特点。
官网网址：Retrofit官网
Github地址:Github
特点1、基于OkHttp并遵循Restfu">
<meta property="og:type" content="article">
<meta property="og:title" content="Retrofit源码学习随笔">
<meta property="og:url" content="https://junbin1011.github.io/2018/08/07/Retrofit源码学习随笔/index.html">
<meta property="og:site_name" content="黄俊彬个人博客">
<meta property="og:description" content="Retrofit是什么？简介Retrofit，中文的翻译为“式样翻新”的意思，是一个基于OKHttp的RESTful网络请求框架。通俗一点来说，Retrofit就是一个网络请求框架的封装。同样是由Square公司开源的Android热门网络框架之一，其具有功能强大、简洁易用及高可拓展性特点。
官网网址：Retrofit官网
Github地址:Github
特点1、基于OkHttp并遵循Restfu">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5125122-e251df442d1596cf?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2019-04-24T08:12:18.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Retrofit源码学习随笔">
<meta name="twitter:description" content="Retrofit是什么？简介Retrofit，中文的翻译为“式样翻新”的意思，是一个基于OKHttp的RESTful网络请求框架。通俗一点来说，Retrofit就是一个网络请求框架的封装。同样是由Square公司开源的Android热门网络框架之一，其具有功能强大、简洁易用及高可拓展性特点。
官网网址：Retrofit官网
Github地址:Github
特点1、基于OkHttp并遵循Restfu">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/5125122-e251df442d1596cf?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://junbin1011.github.io/2018/08/07/Retrofit源码学习随笔/"/>





  <title> Retrofit源码学习随笔 | 黄俊彬个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b3ffb4912eee79c795100275f268095c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黄俊彬个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">优秀是一种习惯，坚持是一种品质。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2018/08/07/Retrofit源码学习随笔/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://avatar.csdn.net/0/6/2/1_junbin1011.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄俊彬个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Retrofit源码学习随笔
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-07T17:06:09+08:00">
                2018-08-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/07/Retrofit源码学习随笔/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/08/07/Retrofit源码学习随笔/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Retrofit是什么？"><a href="#Retrofit是什么？" class="headerlink" title="Retrofit是什么？"></a>Retrofit是什么？</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Retrofit，中文的翻译为“式样翻新”的意思，是一个基于OKHttp的RESTful网络请求框架。通俗一点来说，Retrofit就是一个网络请求框架的封装。同样是由Square公司开源的Android热门网络框架之一，其具有功能强大、简洁易用及高可拓展性特点。</p>
<p>官网网址：<a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit官网</a></p>
<p>Github地址:<a href="https://github.com/square/retrofit" target="_blank" rel="external">Github</a></p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>1、基于OkHttp并遵循Restful API设计风格</p>
<p>2、通过注解的形式，可简便的配置网络请求参数</p>
<p>3、支持同步及异步的网络请求方式</p>
<p>4、支持RxJava</p>
<p>5、支持多种数据格式的解析（Json、XML、Protobuf等）</p>
<h1 id="Retrofit怎么用？"><a href="#Retrofit怎么用？" class="headerlink" title="Retrofit怎么用？"></a>Retrofit怎么用？</h1><p>1、gradle引入库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">implementation &apos;com.squareup.retrofit2:retrofit:2.4.0&apos;</div><div class="line">implementation &apos;com.squareup.retrofit2:converter-gson:2.4.0&apos; //配置使用Gson解析响应数据 可选</div><div class="line">implementation &apos;com.squareup.retrofit2:adapter-rxjava:2.4.0&apos; //配置支持RxJava 可选</div></pre></td></tr></table></figure></p>
<p>2、初始化Retrofit对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = new Retrofit.Builder()</div><div class="line">              .baseUrl(BASE_URL) //配置baseUrl</div><div class="line">              .addConverterFactory(GsonConverterFactory.create()) //配置使用Gson解析响应数据</div><div class="line">              .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) //配置支持RxJava</div><div class="line">              .build();</div></pre></td></tr></table></figure>
<h2 id="网络接口定义"><a href="#网络接口定义" class="headerlink" title="网络接口定义"></a>网络接口定义</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public interface WeatherService &#123;</div><div class="line">        //使用GET请求 直接返回原始数据</div><div class="line">        @GET(&quot;weather?location=%E5%98%89%E5%85%B4&amp;output=json&amp;ak=5slgyqGDENN7Sy7pw29IUvrZ&quot;)</div><div class="line">        Call&lt;ResponseBody&gt; cityNameQueryWeather();</div><div class="line">        </div><div class="line">        //使用GET请求 返回Json映射对象</div><div class="line">        @GET(&quot;&#123;weather&#125;?location=%E5%98%89%E5%85%B4&amp;output=json&quot;)</div><div class="line">        Call&lt;WeatherResp&gt; cityWeatherPath(@Path(&quot;weather&quot;) String weather, @Query(&quot;ak&quot;) String ak);</div><div class="line">        </div><div class="line">       //使用POST请求 支持RxJava返回</div><div class="line">        @FormUrlEncoded()</div><div class="line">        @POST(&quot;&#123;weather&#125;&quot;)</div><div class="line">        rx.Observable&lt;WeatherResp&gt; cityWeatherPost(@Path(&quot;weather&quot;) String weather, @Field(&quot;ak&quot;) String ak, @Field(&quot;location&quot;) String location, @Field(&quot;output&quot;) String output);</div><div class="line">        </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h2 id="同步请求"><a href="#同步请求" class="headerlink" title="同步请求"></a>同步请求</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">WeatherService weatherService = retrofit.create(WeatherService.class);</div><div class="line">        Call&lt;ResponseBody&gt; responseBodyCall = weatherService.cityNameQueryWeather();</div><div class="line">        try &#123;</div><div class="line">            Response&lt;ResponseBody&gt; responseBody = responseBodyCall.execute();</div><div class="line">            System.out.println(&quot;call:&quot; + responseBody.body().string());</div><div class="line"></div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h2 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a>异步请求</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">WeatherService weatherService = retrofit.create(WeatherService.class);</div><div class="line">       Call&lt;WeatherResp&gt; responseBodyCall = weatherService.cityWeatherPath(&quot;weather&quot;, &quot;5slgyqGDENN7Sy7pw29IUvrZ&quot;);</div><div class="line">       responseBodyCall.enqueue(new Callback&lt;WeatherResp&gt;() &#123;</div><div class="line">           @Override</div><div class="line">           public void onResponse(Call&lt;WeatherResp&gt; call, Response&lt;WeatherResp&gt; response) &#123;</div><div class="line">               System.out.println(&quot;call:&quot; + response.toString());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onFailure(Call&lt;WeatherResp&gt; call, Throwable t) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<h2 id="RxJava支持"><a href="#RxJava支持" class="headerlink" title="RxJava支持"></a>RxJava支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">WeatherService weatherService = retrofit.create(WeatherService.class);</div><div class="line">       weatherService.rxCityWeatherPost(&quot;weather&quot;, &quot;5slgyqGDENN7Sy7pw29IUvrZ&quot;, &quot;%E5%98%89%E5%85%B4&quot;, &quot;json&quot;)</div><div class="line">               .subscribeOn(Schedulers.io())        //在新线程里面处理网络请求</div><div class="line">               .observeOn(AndroidSchedulers.mainThread())  //在主线程里面接受返回的数据</div><div class="line">               .subscribe(new rx.Observer&lt;WeatherResp&gt;() &#123;</div><div class="line">                   @Override</div><div class="line">                   public void onCompleted() &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onError(Throwable e) &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onNext(WeatherResp weatherResp) &#123;</div><div class="line">                       System.out.println(&quot;call:&quot; + weatherResp.toString());</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div></pre></td></tr></table></figure>
<p>详细的Retrofit的注解配置及各注解的使用，推荐参考</p>
<p><a href="https://blog.csdn.net/carson_ho/article/details/73732076" target="_blank" rel="external">这是一份很详细的 Retrofit 2.0 使用教程（含实例讲解）</a></p>
<h1 id="Retrofit核心执行流程是怎样？"><a href="#Retrofit核心执行流程是怎样？" class="headerlink" title="Retrofit核心执行流程是怎样？"></a>Retrofit核心执行流程是怎样？</h1><h2 id="关键类功能说明"><a href="#关键类功能说明" class="headerlink" title="关键类功能说明"></a>关键类功能说明</h2><table>
<thead>
<tr>
<th>类</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Retrofit</td>
<td>里面包含了很多对象，serviceMethodCache(自定义的接口映射对象集合)、baseUrl（请求地址）、callFactory（默认为OKHttpCall）、converterFactories（数据解析器工厂集合）、callAdapterFactories（Call适配器工厂集合）、callbackExecutor（回调执行，Android平台默认为MainThreadExecutor）使用Builder模型构建</td>
</tr>
<tr>
<td>Platform</td>
<td>Retrofit中用来管理多平台的方法，支持Android、Java8。通过findPlatform获取对应的平台，同时也初始化了defaultCallAdapterFactory工厂</td>
</tr>
<tr>
<td>ServiceMethod</td>
<td>接口映射的网络请求对象，通过动态代理，将自定义接口的标注转换为该对象，将标注及参数生成OkHttp所需的Request对象。Retrofit的create通过动态代理拦截，将每一个自定义接口转换成为一个ServiceMethod对象，并通过通过serviceMethodCache进行缓存。</td>
</tr>
<tr>
<td>Call<t></t></td>
<td>Retrofit定义的网络请求接口，包含execute、enqueue等方法</td>
</tr>
<tr>
<td>OkHttpCall</td>
<td>Ohttp的Call实现，通过createRawCall得到真正的 okhttp3.Call对象，用于进行实际的网络请求</td>
</tr>
<tr>
<td>CallAdapter.Factory</td>
<td>CallAdapter的静态工厂，包含get的抽象方法，用于生产CallAdapter对象</td>
</tr>
<tr>
<td>ExecutorCallAdapterFactory</td>
<td>Android平台默认的CallAdapter工厂，get方法使用匿名内部类实现CallAdapter，返回ExecutorCallbackCall，实现了Call</td>
</tr>
<tr>
<td>ExecutorCallbackCall</td>
<td>采用静态代理设计，delegate实际为OkHttpCall，使用callbackExecutor实现回调在主线程中执行</td>
</tr>
<tr>
<td>RxJavaCallAdapterFactory</td>
<td>Rxjava平台的CallAdapter工厂，get方法返回RxJavaCallAdapter对象</td>
</tr>
<tr>
<td>RxJavaCallAdapter</td>
<td>Rxjava平台的设配器，返回observable对象</td>
</tr>
<tr>
<td>Converter.Factory</td>
<td>数据解析器工厂，用于生产Converter实例</td>
</tr>
<tr>
<td>GsonConverterFactory</td>
<td>数据解析工厂实例，返回了GsonResponseBodyConverter数据解析器</td>
</tr>
<tr>
<td>GsonResponseBodyConverter</td>
<td>Gson的数据解析器，将服务端返回的json对象转换成对应的java模型</td>
</tr>
<tr>
<td>Response<t></t></td>
<td>Retrofit网络请求响应的Response</td>
</tr>
</tbody>
</table>
<h2 id="代码执行流程"><a href="#代码执行流程" class="headerlink" title="代码执行流程"></a>代码执行流程</h2><p><img src="http://upload-images.jianshu.io/upload_images/5125122-e251df442d1596cf?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<ol>
<li>通过Build模式构建Retrofit对象</li>
<li>自定义的接口interface，包含接口方法及相关标注</li>
<li>执行定义的接口方法</li>
<li>通过Proxy.newProxyInstance进行动态代理拦截</li>
<li>通过反射将定义的标注方法解析生成ServiceMethod对象（表示一个网络请求的封装对象）并加入serviceMethodCache队列中，避免重复解析</li>
<li>创建OkHttpCall对象， 继承了Call<t>接口，桥接okhttp3.Call rawCall</t></li>
<li>从Retrofit对象的callAdapterFactories工厂集合获取CallAdapter，并调用adapt方法。如果是默认的使用ExecutorCallAdapterFactory设配返回Call<object>，如果设置了RxJavaCallAdapterFactory，返回observable。</object></li>
<li>获取适配器转换后的对象，执行同步请求或者异步请求。</li>
<li>创建Okhttp的RealCall对象</li>
<li>通过反射的arg参数，调用serviceMethod.toCall()，构建生成Okhttp的RealCall所需要的Request对象</li>
<li>通过OkHttp的RealCall执行对应的同步或异步请求</li>
<li>请求成功，通过parseResponse解析请求参数</li>
<li>通过数据转换器responseConverter.convert(body)，将原始数据转换为对象</li>
<li>回调解析完的数据对象Respone(T)</li>
</ol>
<h1 id="Retrofit-如何将定义的interface转换成网络请求？"><a href="#Retrofit-如何将定义的interface转换成网络请求？" class="headerlink" title="Retrofit 如何将定义的interface转换成网络请求？"></a>Retrofit 如何将定义的interface转换成网络请求？</h1><p>我们都知道，Retrofit通过自定义interface及相关的标注来描述一个http的请求，使用非常简便，且易于维护。</p>
<p>这是Retrofit设计的精髓之一，，当调用Retrofit的create()方法时，会进行动态代理监听。当执行具体的接口方法时，会回调InvocationHandler。通过反射解析method的标注及参数，生成ServiceMethod对象，ServiceMethod中封装了OKHttp网络请求所需的相关参数。</p>
<p>源码实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public &lt;T&gt; T create(final Class&lt;T&gt; service) &#123;</div><div class="line">   Utils.validateServiceInterface(service);</div><div class="line">   if (validateEagerly) &#123;</div><div class="line">     eagerlyValidateMethods(service);</div><div class="line">   &#125;</div><div class="line">   return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">       new InvocationHandler() &#123;</div><div class="line">         private final Platform platform = Platform.get();</div><div class="line"></div><div class="line">         @Override public Object invoke(Object proxy, Method method, @Nullable Object[] args)</div><div class="line">             throws Throwable &#123;</div><div class="line">           // If the method is a method from Object then defer to normal invocation.</div><div class="line">           if (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">             return method.invoke(this, args);</div><div class="line">           &#125;</div><div class="line">           if (platform.isDefaultMethod(method)) &#123;</div><div class="line">             return platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">           &#125;</div><div class="line">           //生成ServiceMethod</div><div class="line">           ServiceMethod&lt;Object, Object&gt; serviceMethod =o</div><div class="line">               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">           OkHttpCall&lt;Object&gt; okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">           return serviceMethod.adapt(okHttpCall);</div><div class="line">         &#125;</div><div class="line">       &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>通过源码我们知道，具体的转换方法为 (ServiceMethod<object, object="">) loadServiceMethod(method)，具体的实现如下：</object,></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) &#123;</div><div class="line">    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method);</div><div class="line">    if (result != null) return result;</div><div class="line"></div><div class="line">    synchronized (serviceMethodCache) &#123;</div><div class="line">      result = serviceMethodCache.get(method);</div><div class="line">      if (result == null) &#123;</div><div class="line">        result = new ServiceMethod.Builder&lt;&gt;(this, method).build();</div><div class="line">        serviceMethodCache.put(method, result);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>通过Builder构建模式，创建一个ServiceMethod对象，并加入缓存，具体的构造实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">Builder(Retrofit retrofit, Method method) &#123;</div><div class="line">     this.retrofit = retrofit;</div><div class="line">     this.method = method;</div><div class="line">     this.methodAnnotations = method.getAnnotations();</div><div class="line">     this.parameterTypes = method.getGenericParameterTypes();</div><div class="line">     this.parameterAnnotationsArray = method.getParameterAnnotations();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   public ServiceMethod build() &#123;</div><div class="line">     callAdapter = createCallAdapter();</div><div class="line">     responseType = callAdapter.responseType();</div><div class="line">     if (responseType == Response.class || responseType == okhttp3.Response.class) &#123;</div><div class="line">       throw methodError(&quot;&apos;&quot;</div><div class="line">           + Utils.getRawType(responseType).getName()</div><div class="line">           + &quot;&apos; is not a valid response body type. Did you mean ResponseBody?&quot;);</div><div class="line">     &#125;</div><div class="line">     responseConverter = createResponseConverter();</div><div class="line"></div><div class="line">     for (Annotation annotation : methodAnnotations) &#123;</div><div class="line">       parseMethodAnnotation(annotation);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (httpMethod == null) &#123;</div><div class="line">       throw methodError(&quot;HTTP method annotation is required (e.g., @GET, @POST, etc.).&quot;);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (!hasBody) &#123;</div><div class="line">       if (isMultipart) &#123;</div><div class="line">         throw methodError(</div><div class="line">             &quot;Multipart can only be specified on HTTP methods with request body (e.g., @POST).&quot;);</div><div class="line">       &#125;</div><div class="line">       if (isFormEncoded) &#123;</div><div class="line">         throw methodError(&quot;FormUrlEncoded can only be specified on HTTP methods with &quot;</div><div class="line">             + &quot;request body (e.g., @POST).&quot;);</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     int parameterCount = parameterAnnotationsArray.length;</div><div class="line">     parameterHandlers = new ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">     for (int p = 0; p &lt; parameterCount; p++) &#123;</div><div class="line">       Type parameterType = parameterTypes[p];</div><div class="line">       if (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">         throw parameterError(p, &quot;Parameter type must not include a type variable or wildcard: %s&quot;,</div><div class="line">             parameterType);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">       if (parameterAnnotations == null) &#123;</div><div class="line">         throw parameterError(p, &quot;No Retrofit annotation found.&quot;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (relativeUrl == null &amp;&amp; !gotUrl) &#123;</div><div class="line">       throw methodError(&quot;Missing either @%s URL or @Url parameter.&quot;, httpMethod);</div><div class="line">     &#125;</div><div class="line">     if (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">       throw methodError(&quot;Non-body HTTP method cannot contain @Body.&quot;);</div><div class="line">     &#125;</div><div class="line">     if (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">       throw methodError(&quot;Form-encoded method must contain at least one @Field.&quot;);</div><div class="line">     &#125;</div><div class="line">     if (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">       throw methodError(&quot;Multipart method must contain at least one @Part.&quot;);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     return new ServiceMethod&lt;&gt;(this);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>build()方法会通过反射去解析method的标注、参数的类型等。详细的解析可参考源码ParameterHandler相关实现，这里主要对流程进行剖析。</p>
<p>总结一下，Retrofit通过自定义interface及相关的标注来描述一个http的请求，当调用Retrofit的create()方法时，会进行动态代理监听。当执行具体的接口方法时，会回调InvocationHandler。通过反射解析method的标注及参数，生成ServiceMethod对象，ServiceMethod中封装了OKHttp网络请求所需的相关参数。这就是Retrofit将定义的interface转换成网络请求对象的过程。</p>
<h1 id="Retrofit的Converter机制是如何实现？"><a href="#Retrofit的Converter机制是如何实现？" class="headerlink" title="Retrofit的Converter机制是如何实现？"></a>Retrofit的Converter机制是如何实现？</h1><h2 id="Converter种类"><a href="#Converter种类" class="headerlink" title="Converter种类"></a>Converter种类</h2><p>Retrofit支持多种数据解析方式，使用时需要在Gradle添加依赖。</p>
<table>
<thead>
<tr>
<th>数据解析器</th>
<th>Gradle依赖</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gson</td>
<td>com.squareup.retrofit2:converter-gson:2.4.0</td>
</tr>
<tr>
<td>Jackson</td>
<td>com.squareup.retrofit2:converter-jackson:2.4.0</td>
</tr>
<tr>
<td>Simple XML</td>
<td>com.squareup.retrofit2:converter-simplexml:2.4.0</td>
</tr>
<tr>
<td>Protobuf</td>
<td>com.squareup.retrofit2:converter-protobuf:2.4.0</td>
</tr>
<tr>
<td>Moshi</td>
<td>com.squareup.retrofit2:converter-moshi:2.4.0</td>
</tr>
<tr>
<td>Wire</td>
<td>com.squareup.retrofit2:converter-wire:2.4.0</td>
</tr>
<tr>
<td>Scalars</td>
<td>com.squareup.retrofit2:converter-scalars:2.4.0</td>
</tr>
</tbody>
</table>
<h2 id="Converter实现流程"><a href="#Converter实现流程" class="headerlink" title="Converter实现流程"></a>Converter实现流程</h2><h3 id="添加Converter工厂"><a href="#添加Converter工厂" class="headerlink" title="添加Converter工厂"></a>添加Converter工厂</h3><p>首先在Retrofit的初始化添加Converter，addConverterFactory(GsonConverterFactory.create())。具体实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public Builder addConverterFactory(Converter.Factory factory) &#123;</div><div class="line">    converterFactories.add(checkNotNull(factory, &quot;factory == null&quot;));</div><div class="line">    return this;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>将Converter的工厂加入到converterFactories集合中。</p>
<h3 id="触发数据转换"><a href="#触发数据转换" class="headerlink" title="触发数据转换"></a>触发数据转换</h3><p>通过上述的流程分析，我们知道Retrofit当网络请求成功后会执行，OkHttpCall中的parseResponse方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">Response&lt;T&gt; parseResponse(okhttp3.Response rawResponse) throws IOException &#123;</div><div class="line">   ResponseBody rawBody = rawResponse.body();</div><div class="line"></div><div class="line">   // Remove the body&apos;s source (the only stateful object) so we can pass the response along.</div><div class="line">   rawResponse = rawResponse.newBuilder()</div><div class="line">       .body(new NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</div><div class="line">       .build();</div><div class="line"></div><div class="line">   int code = rawResponse.code();</div><div class="line">   if (code &lt; 200 || code &gt;= 300) &#123;</div><div class="line">     try &#123;</div><div class="line">       // Buffer the entire body to avoid future I/O.</div><div class="line">       ResponseBody bufferedBody = Utils.buffer(rawBody);</div><div class="line">       return Response.error(bufferedBody, rawResponse);</div><div class="line">     &#125; finally &#123;</div><div class="line">       rawBody.close();</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   if (code == 204 || code == 205) &#123;</div><div class="line">     rawBody.close();</div><div class="line">     return Response.success(null, rawResponse);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   ExceptionCatchingRequestBody catchingBody = new ExceptionCatchingRequestBody(rawBody);</div><div class="line">   try &#123;</div><div class="line">     T body = serviceMethod.toResponse(catchingBody);</div><div class="line">     return Response.success(body, rawResponse);</div><div class="line">   &#125; catch (RuntimeException e) &#123;</div><div class="line">     // If the underlying source threw an exception, propagate that rather than indicating it was</div><div class="line">     // a runtime exception.</div><div class="line">     catchingBody.throwIfCaught();</div><div class="line">     throw e;</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>其中关键的代码为 T body = serviceMethod.toResponse(catchingBody)，具体实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/** Builds a method return value from an HTTP response body. */</div><div class="line"> R toResponse(ResponseBody body) throws IOException &#123;</div><div class="line">   return responseConverter.convert(body);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="数据转换器的创建"><a href="#数据转换器的创建" class="headerlink" title="数据转换器的创建"></a>数据转换器的创建</h3><p>这里就是 Converter实现转换的地方，那么responseConverter在哪里进行初始化呢？在ServiceMethod的Build方法中，会调用createResponseConverter()进行数据解析器的创建，实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private Converter&lt;ResponseBody, T&gt; createResponseConverter() &#123;</div><div class="line">     Annotation[] annotations = method.getAnnotations();</div><div class="line">     try &#123;</div><div class="line">       return retrofit.responseBodyConverter(responseType, annotations);</div><div class="line">     &#125; catch (RuntimeException e) &#123; // Wide exception range because factories are user code.</div><div class="line">       throw methodError(e, &quot;Unable to create converter for %s&quot;, responseType);</div><div class="line">     &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>调用了 retrofit.responseBodyConverter方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public &lt;T&gt; Converter&lt;ResponseBody, T&gt; responseBodyConverter(Type type, Annotation[] annotations) &#123;</div><div class="line">   return nextResponseBodyConverter(null, type, annotations);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>调用了 retrofit.nextResponseBodyConverter方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">public &lt;T&gt; Converter&lt;ResponseBody, T&gt; nextResponseBodyConverter(</div><div class="line">     @Nullable Converter.Factory skipPast, Type type, Annotation[] annotations) &#123;</div><div class="line">   checkNotNull(type, &quot;type == null&quot;);</div><div class="line">   checkNotNull(annotations, &quot;annotations == null&quot;);</div><div class="line"></div><div class="line">   int start = converterFactories.indexOf(skipPast) + 1;</div><div class="line">   for (int i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">     Converter&lt;ResponseBody, ?&gt; converter =</div><div class="line">         converterFactories.get(i).responseBodyConverter(type, annotations, this);</div><div class="line">     if (converter != null) &#123;</div><div class="line">       //noinspection unchecked</div><div class="line">       return (Converter&lt;ResponseBody, T&gt;) converter;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   StringBuilder builder = new StringBuilder(&quot;Could not locate ResponseBody converter for &quot;)</div><div class="line">       .append(type)</div><div class="line">       .append(&quot;.\n&quot;);</div><div class="line">   if (skipPast != null) &#123;</div><div class="line">     builder.append(&quot;  Skipped:&quot;);</div><div class="line">     for (int i = 0; i &lt; start; i++) &#123;</div><div class="line">       builder.append(&quot;\n   * &quot;).append(converterFactories.get(i).getClass().getName());</div><div class="line">     &#125;</div><div class="line">     builder.append(&apos;\n&apos;);</div><div class="line">   &#125;</div><div class="line">   builder.append(&quot;  Tried:&quot;);</div><div class="line">   for (int i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">     builder.append(&quot;\n   * &quot;).append(converterFactories.get(i).getClass().getName());</div><div class="line">   &#125;</div><div class="line">   throw new IllegalArgumentException(builder.toString());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>通过Retrofit的converterFactories工厂集合匹配获取开始添加的数据转换工厂</p>
<h3 id="默认的数据转换工厂"><a href="#默认的数据转换工厂" class="headerlink" title="默认的数据转换工厂"></a>默认的数据转换工厂</h3><p>通过Retrofit build() 中发现如下代码，converterFactories.add(new BuiltInConverters())，可知Retrofit默认的数据转换器工厂为BuiltInConverters。主要实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"> public Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">     Retrofit retrofit) &#123;</div><div class="line">   if (type == ResponseBody.class) &#123;</div><div class="line">     return Utils.isAnnotationPresent(annotations, Streaming.class)</div><div class="line">         ? StreamingResponseBodyConverter.INSTANCE</div><div class="line">         : BufferingResponseBodyConverter.INSTANCE;</div><div class="line">   &#125;</div><div class="line">   if (type == Void.class) &#123;</div><div class="line">     return VoidResponseBodyConverter.INSTANCE;</div><div class="line">   &#125;</div><div class="line">   return null;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>会将数据转换为ResponseBody对象，所以如果Retrofit默认不使用任何数据解析器，定义interface方法时接收数据对象使用 Call<responsebody>。</responsebody></p>
<h1 id="Retrofit的CallAdapter机制是如何实现？"><a href="#Retrofit的CallAdapter机制是如何实现？" class="headerlink" title="Retrofit的CallAdapter机制是如何实现？"></a>Retrofit的CallAdapter机制是如何实现？</h1><p>Retrofit支持多种网络请求适配器方式：guava、Java8和rxjava 。Android默认的适配器工厂为ExecutorCallAdapterFactory，最后的回调通过ExecutorCallbackCall切换至主线程运行。</p>
<h2 id="CallAdapter种类"><a href="#CallAdapter种类" class="headerlink" title="CallAdapter种类"></a>CallAdapter种类</h2><table>
<thead>
<tr>
<th>网络请求适配器</th>
<th>Gradle依赖</th>
</tr>
</thead>
<tbody>
<tr>
<td>guava</td>
<td>com.squareup.retrofit2:adapter-guava:2.4.0</td>
</tr>
<tr>
<td>Java8</td>
<td>com.squareup.retrofit2:adapter-java8:2.4.0</td>
</tr>
<tr>
<td>rxjava</td>
<td>com.squareup.retrofit2:adapter-rxjava:2.4.0</td>
</tr>
</tbody>
</table>
<h2 id="CallAdapter实现流程"><a href="#CallAdapter实现流程" class="headerlink" title="CallAdapter实现流程"></a>CallAdapter实现流程</h2><h3 id="添加CallAdapter工厂"><a href="#添加CallAdapter工厂" class="headerlink" title="添加CallAdapter工厂"></a>添加CallAdapter工厂</h3><p>首先在Retrofit的初始化添加CallAdapter工厂，addCallAdapterFactory(RxJavaCallAdapterFactory.create())。具体实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public Builder addCallAdapterFactory(CallAdapter.Factory factory) &#123;</div><div class="line">  callAdapterFactories.add(checkNotNull(factory, &quot;factory == null&quot;));</div><div class="line">  return this;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将CallAdapter的工厂加入到callAdapterFactories集合中。</p>
<h3 id="CallAdapter的adapt实现"><a href="#CallAdapter的adapt实现" class="headerlink" title="CallAdapter的adapt实现"></a>CallAdapter的adapt实现</h3><p>通过上述Retrofit的create方法中分析可知，当拦截到interface的方法调用后最后会执行 return serviceMethod.adapt(okHttpCall)。adapt的实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">T adapt(Call&lt;R&gt; call) &#123;</div><div class="line">  return callAdapter.adapt(call);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是在这个地方触发了callAdapter的adapt方法。返回最终适配的具体对象。</p>
<h3 id="默认的CallAdapter工厂"><a href="#默认的CallAdapter工厂" class="headerlink" title="默认的CallAdapter工厂"></a>默认的CallAdapter工厂</h3><p>Android平台默认的CallAdapter工厂为ExecutorCallAdapterFactory。通过Retrofit的build()方法可知：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// Make a defensive copy of the adapters and add the default Call adapter.</div><div class="line">     List&lt;CallAdapter.Factory&gt; callAdapterFactories = new ArrayList&lt;&gt;(this.callAdapterFactories);</div><div class="line">     callAdapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div></pre></td></tr></table></figure></p>
<p>platform.defaultCallAdapterFactory的实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CallAdapter.Factory defaultCallAdapterFactory(@Nullable Executor callbackExecutor) &#123;</div><div class="line">   if (callbackExecutor != null) &#123;</div><div class="line">     return new ExecutorCallAdapterFactory(callbackExecutor);</div><div class="line">   &#125;</div><div class="line">   return DefaultCallAdapterFactory.INSTANCE;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>ExecutorCallAdapterFactory的CallAdapter创建如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">       if (getRawType(returnType) != Call.class) &#123;</div><div class="line">           return null;</div><div class="line">       &#125; else &#123;</div><div class="line">           final Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">           return new CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">               public Type responseType() &#123;</div><div class="line">                   return responseType;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               public Call&lt;Object&gt; adapt(Call&lt;Object&gt; call) &#123;</div><div class="line">                   return new ExecutorCallAdapterFactory.ExecutorCallbackCall(ExecutorCallAdapterFactory.this.callbackExecutor, call);</div><div class="line">               &#125;</div><div class="line">           &#125;;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>adapt方法最后返回还是Call<object>对象，具体的适配实现由ExecutorCallbackCall执行，具体源码如下：</object></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"> static final class ExecutorCallbackCall&lt;T&gt; implements Call&lt;T&gt; &#123;</div><div class="line">        final Executor callbackExecutor;</div><div class="line">        final Call&lt;T&gt; delegate;</div><div class="line"></div><div class="line">        ExecutorCallbackCall(Executor callbackExecutor, Call&lt;T&gt; delegate) &#123;</div><div class="line">            this.callbackExecutor = callbackExecutor;</div><div class="line">            this.delegate = delegate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void enqueue(final Callback&lt;T&gt; callback) &#123;</div><div class="line">            Utils.checkNotNull(callback, &quot;callback == null&quot;);</div><div class="line">            this.delegate.enqueue(new Callback&lt;T&gt;() &#123;</div><div class="line">                public void onResponse(Call&lt;T&gt; call, final Response&lt;T&gt; response) &#123;</div><div class="line">                    ExecutorCallbackCall.this.callbackExecutor.execute(new Runnable() &#123;</div><div class="line">                        public void run() &#123;</div><div class="line">                            if (ExecutorCallbackCall.this.delegate.isCanceled()) &#123;</div><div class="line">                                callback.onFailure(ExecutorCallbackCall.this, new IOException(&quot;Canceled&quot;));</div><div class="line">                            &#125; else &#123;</div><div class="line">                                callback.onResponse(ExecutorCallbackCall.this, response);</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                public void onFailure(Call&lt;T&gt; call, final Throwable t) &#123;</div><div class="line">                    ExecutorCallbackCall.this.callbackExecutor.execute(new Runnable() &#123;</div><div class="line">                        public void run() &#123;</div><div class="line">                            callback.onFailure(ExecutorCallbackCall.this, t);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">        public Response&lt;T&gt; execute() throws IOException &#123;</div><div class="line">            return this.delegate.execute();</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体的执行还是通过delegate（OkHttpCall）来执行，但是在回调使用了 ExecutorCallbackCall.this.callbackExecutor.execute()方法，Android平台的callbackExecutor实现为MainThreadExecutor。具体源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">static class MainThreadExecutor implements Executor &#123;</div><div class="line">      private final Handler handler = new Handler(Looper.getMainLooper());</div><div class="line"></div><div class="line">      @Override public void execute(Runnable r) &#123;</div><div class="line">        handler.post(r);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>所以ExecutorCallAdapterFactory中适配最后的设配对象还是Call<object>,实现还是OkHttpCall，通过 MainThreadExecutor，将回调切换在UI线程中运行</object></p>
<h3 id="CallAdapter的创建"><a href="#CallAdapter的创建" class="headerlink" title="CallAdapter的创建"></a>CallAdapter的创建</h3><p>在ServiceMethod的Build方法中，createCallAdapter()进行适配器的的创建，实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">private CallAdapter&lt;T, R&gt; createCallAdapter() &#123;</div><div class="line">    Type returnType = method.getGenericReturnType();</div><div class="line">    if (Utils.hasUnresolvableType(returnType)) &#123;</div><div class="line">      throw methodError(</div><div class="line">          &quot;Method return type must not include a type variable or wildcard: %s&quot;, returnType);</div><div class="line">    &#125;</div><div class="line">    if (returnType == void.class) &#123;</div><div class="line">      throw methodError(&quot;Service methods cannot return void.&quot;);</div><div class="line">    &#125;</div><div class="line">    Annotation[] annotations = method.getAnnotations();</div><div class="line">    try &#123;</div><div class="line">      //noinspection unchecked</div><div class="line">      return (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</div><div class="line">    &#125; catch (RuntimeException e) &#123; // Wide exception range because factories are user code.</div><div class="line">      throw methodError(e, &quot;Unable to create call adapter for %s&quot;, returnType);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>调用了 retrofit.callAdapter</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> public CallAdapter&lt;?, ?&gt; callAdapter(Type returnType, Annotation[] annotations) &#123;</div><div class="line">  return nextCallAdapter(null, returnType, annotations);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用了 retrofit.nextCallAdapter</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public CallAdapter&lt;?, ?&gt; nextCallAdapter(@Nullable CallAdapter.Factory skipPast, Type returnType,</div><div class="line">    Annotation[] annotations) &#123;</div><div class="line">  checkNotNull(returnType, &quot;returnType == null&quot;);</div><div class="line">  checkNotNull(annotations, &quot;annotations == null&quot;);</div><div class="line"></div><div class="line">  int start = callAdapterFactories.indexOf(skipPast) + 1;</div><div class="line">  for (int i = start, count = callAdapterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">    CallAdapter&lt;?, ?&gt; adapter = callAdapterFactories.get(i).get(returnType, annotations, this);</div><div class="line">    if (adapter != null) &#123;</div><div class="line">      return adapter;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  StringBuilder builder = new StringBuilder(&quot;Could not locate call adapter for &quot;)</div><div class="line">      .append(returnType)</div><div class="line">      .append(&quot;.\n&quot;);</div><div class="line">  if (skipPast != null) &#123;</div><div class="line">    builder.append(&quot;  Skipped:&quot;);</div><div class="line">    for (int i = 0; i &lt; start; i++) &#123;</div><div class="line">      builder.append(&quot;\n   * &quot;).append(callAdapterFactories.get(i).getClass().getName());</div><div class="line">    &#125;</div><div class="line">    builder.append(&apos;\n&apos;);</div><div class="line">  &#125;</div><div class="line">  builder.append(&quot;  Tried:&quot;);</div><div class="line">  for (int i = start, count = callAdapterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">    builder.append(&quot;\n   * &quot;).append(callAdapterFactories.get(i).getClass().getName());</div><div class="line">  &#125;</div><div class="line">  throw new IllegalArgumentException(builder.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过Retrofit的callAdapterFactories工厂集合匹配获取开始添加的适配器工厂</p>
<h1 id="如何自定义一个Converter及CallAdapter？"><a href="#如何自定义一个Converter及CallAdapter？" class="headerlink" title="如何自定义一个Converter及CallAdapter？"></a>如何自定义一个Converter及CallAdapter？</h1><h2 id="自定义Converter"><a href="#自定义Converter" class="headerlink" title="自定义Converter"></a>自定义Converter</h2><p>1、需要定义一个工厂类继承Converter.Factory</p>
<p>2、复写responseBodyConverter及requestBodyConverter方法</p>
<p>3、在Retrofit定义时加入自定义的Converter，addConverterFactory(new CustomConverterFactory())</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * @author allen</div><div class="line"> * @date 2018/8/7</div><div class="line"> * 返回服务端返回的string结果</div><div class="line"> */</div><div class="line">public class CustomConverterFactory extends Converter.Factory &#123;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">        return StringResponseBodyConverter.INSTANCE;</div><div class="line">    &#125;</div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</div><div class="line">        return StringRequestBodyConverter.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static final class StringResponseBodyConverter implements Converter&lt;ResponseBody, String&gt; &#123;</div><div class="line">        static final CustomConverterFactory.StringResponseBodyConverter INSTANCE = new CustomConverterFactory.StringResponseBodyConverter();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public String convert(ResponseBody value) &#123;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                System.out.println(&quot;CustomConverterFactory&quot;);</div><div class="line">                return value.string();</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            return &quot;&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    static final class StringRequestBodyConverter implements Converter&lt;RequestBody, RequestBody&gt; &#123;</div><div class="line">        static final CustomConverterFactory.StringRequestBodyConverter INSTANCE = new CustomConverterFactory.StringRequestBodyConverter();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public RequestBody convert(@NonNull RequestBody value) &#123;</div><div class="line">            return value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="自定义CallAdapter"><a href="#自定义CallAdapter" class="headerlink" title="自定义CallAdapter"></a>自定义CallAdapter</h2><p>1、需要定义一个工厂类继承CallAdapter.Factory</p>
<p>2、复写CallAdapter&lt;?, ?&gt; get方法</p>
<p>3、在Retrofit定义时加入自定义的CallAdapter， addCallAdapterFactory(new CustomCallAdapterFactory())</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * @author allen</div><div class="line"> * @date 2018/8/7</div><div class="line"> */</div><div class="line">public class CustomCallAdapterFactory extends CallAdapter.Factory &#123;</div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line"></div><div class="line">        return new CallAdapter&lt;Object, Object&gt;() &#123;</div><div class="line">            @Override</div><div class="line">            public Type responseType() &#123;</div><div class="line">                return String.class;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public Object adapt(Call&lt;Object&gt; call) &#123;</div><div class="line">                System.out.println(&quot;CustomCallAdapterFactory adapt(&quot;);</div><div class="line">                return call;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Retrofit中运用了那些设计模式？"><a href="#Retrofit中运用了那些设计模式？" class="headerlink" title="Retrofit中运用了那些设计模式？"></a>Retrofit中运用了那些设计模式？</h1><p>1、建造者模式</p>
<p>Retrofit对象的创建、ServiceMethod对象创建都使用Build模式，将复杂对象的创建和表示分离，调用者不需要知道复杂的创建过程，使用Build的相关方法进行配置创建对象。</p>
<p>2、外观模式 </p>
<p>Retrofit对外提供了统一的调度，屏蔽了内部的实现，使得使用该网络库简单便捷。</p>
<p>3、动态代理模式</p>
<p>通过动态代理的方式，当调用Retrofit的create()方法时，会进行动态代理监听。当执行具体的接口方法时，会回调InvocationHandler。通过反射解析method的标注及参数，生成ServiceMethod对象。</p>
<p>4、静态代理模式<br>Android平台默认的适配器ExecutorCallbackCall，采用静态代理的模式。具体的实现delegate为OkHttpCall。</p>
<p>5、工厂模式<br>Converter及CallAdapter的创建都采用了工厂模式进行创建。</p>
<p>6、适配器模式<br>CallAdapter的adapt采用了适配器模式，使得interface的返回对象可以动态扩展，增强了灵活性</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>大多数流行的开源框架都是经过顶级coder的设计，包含了很多精妙的设计。多学习分析，收益良多。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/carson_ho/article/details/73732076" target="_blank" rel="external">这是一份很详细的 Retrofit 2.0 使用教程（含实例讲解）</a></p>
<p><a href="https://blog.csdn.net/carson_ho/article/details/73732115" target="_blank" rel="external">Android：手把手带你深入剖析 Retrofit 2.0 源码</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/02/OkHttp源码学习随笔/" rel="next" title="OkHttp源码学习随笔">
                <i class="fa fa-chevron-left"></i> OkHttp源码学习随笔
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/13/Glide源码学习随笔/" rel="prev" title="Glide源码学习随笔">
                Glide源码学习随笔 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/08/07/Retrofit源码学习随笔/"
           data-title="Retrofit源码学习随笔" data-url="https://junbin1011.github.io/2018/08/07/Retrofit源码学习随笔/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://avatar.csdn.net/0/6/2/1_junbin1011.jpg"
               alt="黄俊彬" />
          <p class="site-author-name" itemprop="name">黄俊彬</p>
           
              <p class="site-description motion-element" itemprop="description">优秀是一种习惯，坚持是一种品质。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">75</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/junbin1011" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/huang-jun-bin-48/" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit是什么？"><span class="nav-number">1.</span> <span class="nav-text">Retrofit是什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特点"><span class="nav-number">1.2.</span> <span class="nav-text">特点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit怎么用？"><span class="nav-number">2.</span> <span class="nav-text">Retrofit怎么用？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络接口定义"><span class="nav-number">2.1.</span> <span class="nav-text">网络接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#同步请求"><span class="nav-number">2.2.</span> <span class="nav-text">同步请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异步请求"><span class="nav-number">2.3.</span> <span class="nav-text">异步请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RxJava支持"><span class="nav-number">2.4.</span> <span class="nav-text">RxJava支持</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit核心执行流程是怎样？"><span class="nav-number">3.</span> <span class="nav-text">Retrofit核心执行流程是怎样？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关键类功能说明"><span class="nav-number">3.1.</span> <span class="nav-text">关键类功能说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码执行流程"><span class="nav-number">3.2.</span> <span class="nav-text">代码执行流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit-如何将定义的interface转换成网络请求？"><span class="nav-number">4.</span> <span class="nav-text">Retrofit 如何将定义的interface转换成网络请求？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit的Converter机制是如何实现？"><span class="nav-number">5.</span> <span class="nav-text">Retrofit的Converter机制是如何实现？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Converter种类"><span class="nav-number">5.1.</span> <span class="nav-text">Converter种类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Converter实现流程"><span class="nav-number">5.2.</span> <span class="nav-text">Converter实现流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加Converter工厂"><span class="nav-number">5.2.1.</span> <span class="nav-text">添加Converter工厂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#触发数据转换"><span class="nav-number">5.2.2.</span> <span class="nav-text">触发数据转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据转换器的创建"><span class="nav-number">5.2.3.</span> <span class="nav-text">数据转换器的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认的数据转换工厂"><span class="nav-number">5.2.4.</span> <span class="nav-text">默认的数据转换工厂</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit的CallAdapter机制是如何实现？"><span class="nav-number">6.</span> <span class="nav-text">Retrofit的CallAdapter机制是如何实现？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CallAdapter种类"><span class="nav-number">6.1.</span> <span class="nav-text">CallAdapter种类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CallAdapter实现流程"><span class="nav-number">6.2.</span> <span class="nav-text">CallAdapter实现流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加CallAdapter工厂"><span class="nav-number">6.2.1.</span> <span class="nav-text">添加CallAdapter工厂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CallAdapter的adapt实现"><span class="nav-number">6.2.2.</span> <span class="nav-text">CallAdapter的adapt实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认的CallAdapter工厂"><span class="nav-number">6.2.3.</span> <span class="nav-text">默认的CallAdapter工厂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CallAdapter的创建"><span class="nav-number">6.2.4.</span> <span class="nav-text">CallAdapter的创建</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何自定义一个Converter及CallAdapter？"><span class="nav-number">7.</span> <span class="nav-text">如何自定义一个Converter及CallAdapter？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义Converter"><span class="nav-number">7.1.</span> <span class="nav-text">自定义Converter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义CallAdapter"><span class="nav-number">7.2.</span> <span class="nav-text">自定义CallAdapter</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Retrofit中运用了那些设计模式？"><span class="nav-number">8.</span> <span class="nav-text">Retrofit中运用了那些设计模式？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思考"><span class="nav-number">9.1.</span> <span class="nav-text">思考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">9.2.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄俊彬</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"junbin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
