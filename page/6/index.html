<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="一花一世界，一码一浮生">
<meta property="og:type" content="website">
<meta property="og:title" content="JunBin">
<meta property="og:url" content="https://junbin1011.github.io/page/6/index.html">
<meta property="og:site_name" content="JunBin">
<meta property="og:description" content="一花一世界，一码一浮生">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JunBin">
<meta name="twitter:description" content="一花一世界，一码一浮生">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://junbin1011.github.io/page/6/">





  <title> JunBin </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b3ffb4912eee79c795100275f268095c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JunBin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一花一世界，一码一浮生</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/20/设计模式-装饰模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/20/设计模式-装饰模式/" itemprop="url">
                  设计模式-装饰模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-20T13:59:01+08:00">
                2017-02-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/20/设计模式-装饰模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/20/设计模式-装饰模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-装饰模式的定义及使用场景"><a href="#1-装饰模式的定义及使用场景" class="headerlink" title="1.装饰模式的定义及使用场景"></a>1.装饰模式的定义及使用场景</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>装饰模式也称为包装模式，结构型设计模式之一，其使用一种对客户端透明的方式来动态地扩展对象的功能，同时它也是继承关系的一种替代方案之一。动态地给一个对象添加一些额外的职责。就增加功能来说，装饰模式相比生成子类更为灵活</p>
<h2 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h2><ul>
<li>需要扩展一个类的功能，或给一个类增加附加功能</li>
<li>需要动态地给一个对象增加功能，这些功能可以再动态地撤销</li>
<li>需要为一批的兄弟类进行改装或加装功能，当然是首选装饰模式</li>
</ul>
<p><img src="http://img.blog.csdn.net/20170220135552081?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="2-装饰模式的优缺点"><a href="#2-装饰模式的优缺点" class="headerlink" title="2. 装饰模式的优缺点"></a>2. 装饰模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><ul>
<li>装饰类和被装饰类可以独立发展，而不会相互耦合。换句话说，Component类无需知道Decorator类，Decorator类是从外部来扩展Component类的功能，而Decorator也不用知道具体的构件</li>
<li>装饰模式是继承关系的一个替代方案。我们看装饰类Decorator，不管装饰多少层，返回的对象还是component，实现的还是is-a的关系</li>
<li>装饰模式可以动态地扩展一个实现类的功能<h2 id="2-2缺点"><a href="#2-2缺点" class="headerlink" title="2.2缺点"></a>2.2缺点</h2>对于装饰模式，多层装饰是比较复杂的。因尽量减少装饰类的数量，以便减低系统的复杂度。<h1 id="3-装饰模式的实现方式"><a href="#3-装饰模式的实现方式" class="headerlink" title="3. 装饰模式的实现方式"></a>3. 装饰模式的实现方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract  class Component &#123;</span><br><span class="line">    public abstract void operator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteComponent extends Component &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void operator() &#123;</span><br><span class="line">        System.out.println(&quot;ConcreteComponent operator&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class Decorator extends Component &#123;</span><br><span class="line">    private Component component;</span><br><span class="line"></span><br><span class="line">    Decorator(Component component) &#123;</span><br><span class="line">        this.component = component;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void operator() &#123;</span><br><span class="line">        if (component != null) &#123;</span><br><span class="line">            component.operator();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteDecorator1 extends Decorator &#123;</span><br><span class="line">    public ConcreteDecorator1(Component component) &#123;</span><br><span class="line">        super(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void method1() &#123;</span><br><span class="line">        System.out.println(&quot;method1 修饰&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void operator() &#123;</span><br><span class="line">        super.operator();</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteDecorator2 extends Decorator &#123;</span><br><span class="line">    public ConcreteDecorator2(Component component) &#123;</span><br><span class="line">        super(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void method2() &#123;</span><br><span class="line">        System.out.println(&quot;method2 修饰&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void operator() &#123;</span><br><span class="line">        super.operator();</span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String args[]) &#123;</span><br><span class="line">        Component component = new ConcreteComponent();</span><br><span class="line">        ConcreteDecorator1 decorator1 = new ConcreteDecorator1(component);</span><br><span class="line">        ConcreteDecorator2 decorator2 = new ConcreteDecorator2(component);</span><br><span class="line">        decorator1.operator();</span><br><span class="line">        decorator2.operator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-装饰模式在Android中的实际应用"><a href="#4-装饰模式在Android中的实际应用" class="headerlink" title="4. 装饰模式在Android中的实际应用"></a>4. 装饰模式在Android中的实际应用</h1><p>Context类本身是一个纯abstract类，他有两个具体的实现子类：ContextImpl和ContextWrapper。其中ContextWrapper类，只是一个包装而已，ContextWrapper构造函数中必须包含一个真正的Context引用，同时ContextWrapper提供了attachBaseContext（）用于给ContextWrapper对象中指定真正的Context对象，调用ContextWrapper的方法都会被转向其所包含的真正的Context对象。</p>
<p>ContextThemeWrapper类，其内部包含了与主题（Theme）相关的接口，这里所说的主题就是指在AndroidMainifest.xml中通过android：theme为Application元素或者Activity元素指定的主题。当然，只有Activity才需要主题，Service是不需要主题的，Application同理。</p>
<p>而ContextImpl类则真正实现了Context中的所有函数，应用程序中所调用的各种Context类的方法，其实现均来于该类。Context的两个子类分工明确，其中ContextImpl是Context的具体实现类，ContextWrapper是Context的包装类。</p>
<p><a href="http://blog.csdn.net/junbin1011/article/details/54612858" target="_blank" rel="noopener">详见 Android之Context底层原理,http://blog.csdn.net/junbin1011/article/details/54612858</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/17/Android事件分发底层原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/17/Android事件分发底层原理/" itemprop="url">
                  Android事件分发底层原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-17T16:03:53+08:00">
                2017-02-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/17/Android事件分发底层原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/17/Android事件分发底层原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><h2 id="1-1事件构成"><a href="#1-1事件构成" class="headerlink" title="1.1事件构成"></a>1.1事件构成</h2><p>在Android中，事件（TouchEvent）主要包括点按、长按、拖拽、滑动等，所有的事件都由如下三个部分组成</p>
<ul>
<li><p>按下（ACTION_DOWN）</p>
</li>
<li><p>移动（ACTION_MOVE）</p>
</li>
<li><p>抬起（ACTION_UP）</p>
</li>
</ul>
<p>一般来说，一次完整的Touch事件，应该是由一个Down、一个Up和若干个Move组成。</p>
<h2 id="1-2View的分发事件"><a href="#1-2View的分发事件" class="headerlink" title="1.2View的分发事件"></a>1.2View的分发事件</h2><ul>
<li><p>public boolean dispatchTouchEvent（MotionEvent ev）<br>如果事件能够传递到当前的View，那么此方法一定会被调用。</p>
</li>
<li><p>public boolean onInterceptTouchEvent（MotionEvent ev）<br>用来判断是否拦截某个事件</p>
</li>
<li><p>public boolean onTouchEvent(MotionEvent ev)<br>用来处理点击事件</p>
</li>
</ul>
<p>ViewGroup的相关事件有三个：onInterceptTouchEvent、dispatchTouchEvent、onTouchEvent。View的相关事件只有两个：dispatchTouchEvent、onTouchEvent。</p>
<h2 id="1-3滑动冲突处理："><a href="#1-3滑动冲突处理：" class="headerlink" title="1.3滑动冲突处理："></a>1.3滑动冲突处理：</h2><p>（1）外部拦截方法 （在父容器的 onInterceptTouchEvent 进行控制，是否分发到子元素），遵循Android规范</p>
<p>（2）内部拦截方法（在子元素通过控制父容器的 requestDisallowInterceptTouchEvent 进行控制）</p>
<h1 id="2-流程"><a href="#2-流程" class="headerlink" title="2.流程"></a>2.流程</h1><p>Android中事件传递按照从上到下再从下到上进行层级传递，事件处理从Activity开始到ViewGroup再到View，如果View没有消费事件会再次从View到ViewGroup再到Activity最后事件被抛出消费掉。流转的流程图如下：<br><img src="http://img.blog.csdn.net/20170217154756479?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<ul>
<li><p>dispatchTouchEvent和TouchEvnet return false的 时候，事件都会回传给父控件的onTouchEvent处理</p>
</li>
<li><p>onInterceptTouchEvent默认为false不进行事件拦截，OnDispatchTouchEvnet默认为true进行事件分发，onTouchEvent需要根据具体的View是否设置了listener及具体View的实现进行区分是否为true</p>
</li>
<li><p>Activity的dispatchTouchEvent不管返回true或false都会进行分发</p>
</li>
<li><p>如果事件在具体的View或者ViewGroup的onTouchEvent返回true，则表明事件被消费，事件传递机制就会结束</p>
<h1 id="3-示例"><a href="#3-示例" class="headerlink" title="3.示例"></a>3.示例</h1><p>具体可以根据流程图修改对应方法返回值进行日志验证。这里就不一一进行日志输出显示。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public class MyView extends Button &#123;</span><br><span class="line">    private String TAG = &quot;MyView&quot;;</span><br><span class="line"></span><br><span class="line">    public MyView(Context context, AttributeSet attrs) &#123;</span><br><span class="line">        super(context, attrs);</span><br><span class="line">        TAG += getTag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">        switch (ev.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;MyView dispatchTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;MyView dispatchTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;MyView dispatchTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        switch (event.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;MyView onTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;MyView onTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;MyView onTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        boolean touch = super.onTouchEvent(event);</span><br><span class="line">        Log.i(TAG, &quot;MyView onTouchEvent--touch&quot; + touch);</span><br><span class="line">        return touch;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public class MyViewGroup extends RelativeLayout &#123;</span><br><span class="line">    private String TAG = &quot;MyViewGroup&quot;;</span><br><span class="line"></span><br><span class="line">    public MyViewGroup(Context context, AttributeSet attrs) &#123;</span><br><span class="line">        super(context, attrs);</span><br><span class="line">        TAG+=getTag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">        switch (ev.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup dispatchTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup dispatchTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup dispatchTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.dispatchTouchEvent(ev) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">        switch (ev.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.d(TAG, &quot;MyViewGroup onInterceptTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.d(TAG, &quot;MyViewGroup onInterceptTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.d(TAG, &quot;MyViewGroup onInterceptTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">       return super.onInterceptTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        switch (event.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup onTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup onTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;MyViewGroup onTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        boolean touch = super.onTouchEvent(event);</span><br><span class="line">        Log.i(TAG, &quot;MyViewGroup onTouchEvent--touch&quot; + touch);</span><br><span class="line">        return touch;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</span><br><span class="line">    android:id=&quot;@+id/activity_main&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:paddingBottom=&quot;@dimen/activity_vertical_margin&quot;</span><br><span class="line">    android:paddingLeft=&quot;@dimen/activity_horizontal_margin&quot;</span><br><span class="line">    android:paddingRight=&quot;@dimen/activity_horizontal_margin&quot;</span><br><span class="line">    android:paddingTop=&quot;@dimen/activity_vertical_margin&quot;</span><br><span class="line">    tools:context=&quot;com.jd.test.myapplication.MainActivity&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com.jd.test.myapplication.view.MyViewGroup</span><br><span class="line">        android:id=&quot;@+id/mg1&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:tag=&quot;mg1&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;com.jd.test.myapplication.view.MyView</span><br><span class="line">            android:id=&quot;@+id/v3&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:tag=&quot;btn3&quot;</span><br><span class="line">            android:text=&quot;btn3&quot; /&gt;</span><br><span class="line">    &lt;/com.jd.test.myapplication.view.MyViewGroup&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">public class ViewEventActivity extends Activity &#123;</span><br><span class="line"></span><br><span class="line">    Button btn3;</span><br><span class="line">    MyViewGroup myViewGroup1;</span><br><span class="line">    private  String  TAG=&quot;ViewEventActivity&quot;;</span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_view_event);</span><br><span class="line">        btn3= (Button) findViewById(R.id.v3);</span><br><span class="line">        myViewGroup1= (MyViewGroup) findViewById(R.id.mg1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">        switch (ev.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;DecorView dispatchTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;DecorView dispatchTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;DecorView dispatchTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.dispatchTouchEvent(ev);</span><br><span class="line">        //return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        switch (event.getAction()) &#123;</span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                Log.i(TAG, &quot;DecorView onTouchEvent--ACTION_DOWN&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                Log.i(TAG, &quot;DecorView onTouchEvent--ACTION_MOVE&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                Log.i(TAG, &quot;DecorView onTouchEvent--ACTION_UP&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        boolean touch=super.onTouchEvent(event);</span><br><span class="line">        Log.d(TAG, &quot;DecorView touch boolean---&quot;+touch);</span><br><span class="line">        return touch;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-源码解析"><a href="#4-源码解析" class="headerlink" title="4.源码解析"></a>4.源码解析</h1><h2 id="1-Activity的TouchEvent流程"><a href="#1-Activity的TouchEvent流程" class="headerlink" title="1.Activity的TouchEvent流程"></a>1.Activity的TouchEvent流程</h2><p>首先看一下Activity的dispatchTouchEvnet源码，实际是调用了Window的 superDispatchTouchEvent();<br>Activity:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">    if (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        onUserInteraction();</span><br><span class="line">    &#125;</span><br><span class="line">    if (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return onTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Window是一个抽象类，他的实现类是PhoneWindow，而PhoneWidow的最底层视图是mDecorView，是一个FrameLayout。其实也就是ViewGroup。<br>PhoneWindow:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">return mDecor.superDispatchTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DecorView的 superDispatchTouchEvent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">return super.dispatchTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 如果Activity有实现 dispatchTouchEvent回调则调用改回调，若没有则调用super的 dispatchTouchEvent，继续往子View进行事件分发<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line"> final Callback cb = getCallback();</span><br><span class="line"> return cb != null &amp;&amp; !isDestroyed() &amp;&amp; mFeatureId &lt; 0 ? cb.dispatchTouchEvent(ev)</span><br><span class="line"> : super.dispatchTouchEvent(ev);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-DispatchTouchEvent"><a href="#2-DispatchTouchEvent" class="headerlink" title="2.DispatchTouchEvent"></a>2.DispatchTouchEvent</h2><p>ViewGroup：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line">  * &#123;@inheritDoc&#125;</span><br><span class="line">  */</span><br><span class="line">  @Override</span><br><span class="line">  public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">  if (mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">  mInputEventConsistencyVerifier.onTouchEvent(ev, 1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//对于辅助功能的事件处理</span><br><span class="line">  if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">  ev.setTargetAccessibilityFocus(false);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  boolean handled = false;</span><br><span class="line">  if (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">  final int action = ev.getAction();</span><br><span class="line">  final int actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line"></span><br><span class="line">  // 处理原始的DOWN事件</span><br><span class="line">  if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">  //这里主要是在新事件开始时处理完上一个事件</span><br><span class="line">  // due to an app switch, ANR, or some other state change.</span><br><span class="line">  cancelAndClearTouchTargets(ev);</span><br><span class="line">  resetTouchState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //检查事件拦截</span><br><span class="line">  final boolean intercepted;</span><br><span class="line">  if (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">  || mFirstTouchTarget != null) &#123;</span><br><span class="line">  final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;</span><br><span class="line">  if (!disallowIntercept) &#123;</span><br><span class="line">  intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">  ev.setAction(action); //恢复事件防止其改变</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  intercepted = false;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  // There are no touch targets and this action is not an initial down</span><br><span class="line">  // so this view group continues to intercept touches.</span><br><span class="line">  intercepted = true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //如果事件被拦截了，则进行正常的事件分发</span><br><span class="line">  if (intercepted || mFirstTouchTarget != null) &#123;</span><br><span class="line">  ev.setTargetAccessibilityFocus(false);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 检查事件是否取消</span><br><span class="line">  final boolean canceled = resetCancelNextUpFlag(this)</span><br><span class="line">  || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line"></span><br><span class="line">  // 如果有必要的话，为DOWN事件检查所有的目标对象</span><br><span class="line">  final boolean split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != 0;</span><br><span class="line">  TouchTarget newTouchTarget = null;</span><br><span class="line">  boolean alreadyDispatchedToNewTouchTarget = false;</span><br><span class="line"></span><br><span class="line">//如果事件未被取消并未被拦截</span><br><span class="line">  if (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line"></span><br><span class="line">  //如果有辅助功能的参与，则直接将事件投递到对应的View，否则将事件分发给所有的子View</span><br><span class="line">  View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</span><br><span class="line">  ? findChildWithAccessibilityFocus() : null;</span><br><span class="line"></span><br><span class="line">  if (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">  || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">  || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">  final int actionIndex = ev.getActionIndex(); // always 0 for down</span><br><span class="line">  final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class="line">  : TouchTarget.ALL_POINTER_IDS;</span><br><span class="line"></span><br><span class="line">  // Clean up earlier touch targets for this pointer id in case they</span><br><span class="line">  // have become out of sync.</span><br><span class="line">  removePointersFromTouchTargets(idBitsToAssign);</span><br><span class="line"></span><br><span class="line">  final int childrenCount = mChildrenCount;</span><br><span class="line"></span><br><span class="line">//如果TouchTarget为空并且子元素不为0</span><br><span class="line">  if (newTouchTarget == null &amp;&amp; childrenCount != 0) &#123;</span><br><span class="line">  final float x = ev.getX(actionIndex);</span><br><span class="line">  final float y = ev.getY(actionIndex);</span><br><span class="line">  //由上至下去寻找一个可以接收改事件的子View</span><br><span class="line">  final ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</span><br><span class="line">  final boolean customOrder = preorderedList == null</span><br><span class="line">  &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">  final View[] children = mChildren;</span><br><span class="line"></span><br><span class="line">//遍历子元素</span><br><span class="line">  for (int i = childrenCount - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">  final int childIndex = customOrder</span><br><span class="line">  ? getChildDrawingOrder(childrenCount, i) : i;</span><br><span class="line">  final View child = (preorderedList == null)</span><br><span class="line">  ? children[childIndex] : preorderedList.get(childIndex);</span><br><span class="line"></span><br><span class="line">  // If there is a view that has accessibility focus we want it</span><br><span class="line">  // to get the event first and if not handled we will perform a</span><br><span class="line">  // normal dispatch. We may do a double iteration but this is</span><br><span class="line">  // safer given the timeframe.</span><br><span class="line">  if (childWithAccessibilityFocus != null) &#123;</span><br><span class="line">  if (childWithAccessibilityFocus != child) &#123;</span><br><span class="line">  continue;</span><br><span class="line">  &#125;</span><br><span class="line">  childWithAccessibilityFocus = null;</span><br><span class="line">  i = childrenCount - 1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//如果这个子元素无法接收Pointer Event或这个事件电压根本就没有在子元素的边界范围内</span><br><span class="line">  if (!canViewReceivePointerEvents(child)</span><br><span class="line">  || !isTransformedTouchPointInView(x, y, child, null)) &#123;</span><br><span class="line">  ev.setTargetAccessibilityFocus(false);</span><br><span class="line"></span><br><span class="line">//那么就跳出该次循环继续遍历</span><br><span class="line">  continue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//找到Event该由那个子元素持有</span><br><span class="line">  newTouchTarget = getTouchTarget(child);</span><br><span class="line">  if (newTouchTarget != null) &#123;</span><br><span class="line">  // Child is already receiving touch within its bounds.</span><br><span class="line">  // Give it the new pointer in addition to the ones it is handling.</span><br><span class="line">  newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">  break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetCancelNextUpFlag(child);</span><br><span class="line">//投递事件执行触摸操作</span><br><span class="line">//如果子元素还是一个ViewGroup，则递归调用重复此过程</span><br><span class="line">//如果子元素还是一个View，那么则会调用View的dispatTouchEvent，</span><br><span class="line">//并最终由onTouchEvent处理</span><br><span class="line"></span><br><span class="line">  if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123;</span><br><span class="line">  // 子View在其边界范围内接收事件</span><br><span class="line">  mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">  if (preorderedList != null) &#123;</span><br><span class="line">  // childIndex points into presorted list, find original index</span><br><span class="line">  for (int j = 0; j &lt; childrenCount; j++) &#123;</span><br><span class="line">  if (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">  mLastTouchDownIndex = j;</span><br><span class="line">  break;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  mLastTouchDownIndex = childIndex;</span><br><span class="line">  &#125;</span><br><span class="line">  mLastTouchDownX = ev.getX();</span><br><span class="line">  mLastTouchDownY = ev.getY();</span><br><span class="line">  newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">  alreadyDispatchedToNewTouchTarget = true;</span><br><span class="line">  break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // The accessibility focus didn&apos;t handle the event, so clear</span><br><span class="line">  // the flag and do a normal dispatch to all children.</span><br><span class="line">  ev.setTargetAccessibilityFocus(false);</span><br><span class="line">  &#125;</span><br><span class="line">  if (preorderedList != null) preorderedList.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//如果发现没有子元素可以持有该次事件</span><br><span class="line">  if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) &#123;</span><br><span class="line">  // Did not find a child to receive the event.</span><br><span class="line">  // Assign the pointer to the least recently added target.</span><br><span class="line">  newTouchTarget = mFirstTouchTarget;</span><br><span class="line">  while (newTouchTarget.next != null) &#123;</span><br><span class="line">  newTouchTarget = newTouchTarget.next;</span><br><span class="line">  &#125;</span><br><span class="line">  newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Dispatch to touch targets.</span><br><span class="line">  if (mFirstTouchTarget == null) &#123;</span><br><span class="line">  // No touch targets so treat this as an ordinary view.</span><br><span class="line">  handled = dispatchTransformedTouchEvent(ev, canceled, null,</span><br><span class="line">  TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  // Dispatch to touch targets, excluding the new touch target if we already</span><br><span class="line">  // dispatched to it. Cancel touch targets if necessary.</span><br><span class="line">  TouchTarget predecessor = null;</span><br><span class="line">  TouchTarget target = mFirstTouchTarget;</span><br><span class="line">  while (target != null) &#123;</span><br><span class="line">  final TouchTarget next = target.next;</span><br><span class="line">  if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class="line">  handled = true;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  final boolean cancelChild = resetCancelNextUpFlag(target.child)</span><br><span class="line">  || intercepted;</span><br><span class="line">  if (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">  target.child, target.pointerIdBits)) &#123;</span><br><span class="line">  handled = true;</span><br><span class="line">  &#125;</span><br><span class="line">  if (cancelChild) &#123;</span><br><span class="line">  if (predecessor == null) &#123;</span><br><span class="line">  mFirstTouchTarget = next;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  predecessor.next = next;</span><br><span class="line">  &#125;</span><br><span class="line">  target.recycle();</span><br><span class="line">  target = next;</span><br><span class="line">  continue;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  predecessor = target;</span><br><span class="line">  target = next;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Update list of touch targets for pointer up or cancel, if needed.</span><br><span class="line">  if (canceled</span><br><span class="line">  || actionMasked == MotionEvent.ACTION_UP</span><br><span class="line">  || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">  resetTouchState();</span><br><span class="line">  &#125; else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</span><br><span class="line">  final int actionIndex = ev.getActionIndex();</span><br><span class="line">  final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex);</span><br><span class="line">  removePointersFromTouchTargets(idBitsToRemove);</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">  mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1);</span><br><span class="line">  &#125;</span><br><span class="line">  return handled;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>View：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Dispatches a key shortcut event.</span><br><span class="line">*</span><br><span class="line">* @param event The key event to be dispatched.</span><br><span class="line">* @return True if the event was handled by the view, false otherwise.</span><br><span class="line">*/</span><br><span class="line">public boolean dispatchKeyShortcutEvent(KeyEvent event) &#123;</span><br><span class="line">return onKeyShortcut(event.getKeyCode(), event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* Pass the touch screen motion event down to the target view, or this</span><br><span class="line">* view if it is the target.</span><br><span class="line">*</span><br><span class="line">* @param event The motion event to be dispatched.</span><br><span class="line">* @return True if the event was handled by the view, false otherwise.</span><br><span class="line">*/</span><br><span class="line">public boolean dispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">// If the event should be handled by accessibility focus first.</span><br><span class="line">if (event.isTargetAccessibilityFocus()) &#123;</span><br><span class="line">// We don&apos;t have focus or no virtual descendant has it, do not handle the event.</span><br><span class="line">if (!isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br><span class="line">// We have focus and got the event, then use normal event dispatch.</span><br><span class="line">event.setTargetAccessibilityFocus(false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boolean result = false;</span><br><span class="line"></span><br><span class="line">if (mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">mInputEventConsistencyVerifier.onTouchEvent(event, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final int actionMasked = event.getActionMasked();</span><br><span class="line">if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">// Defensive cleanup for new gesture</span><br><span class="line">stopNestedScroll();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">//noinspection SimplifiableIfStatement</span><br><span class="line">ListenerInfo li = mListenerInfo;</span><br><span class="line">if (li != null &amp;&amp; li.mOnTouchListener != null</span><br><span class="line">&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">&amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</span><br><span class="line">result = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">result = true;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!result &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">mInputEventConsistencyVerifier.onUnhandledEvent(event, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Clean up after nested scrolls if this is the end of a gesture;</span><br><span class="line">// also cancel it if we tried an ACTION_DOWN but we didn&apos;t want the rest</span><br><span class="line">// of the gesture.</span><br><span class="line">if (actionMasked == MotionEvent.ACTION_UP ||</span><br><span class="line">actionMasked == MotionEvent.ACTION_CANCEL ||</span><br><span class="line">(actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</span><br><span class="line">stopNestedScroll();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-onInterceptTouchEvent"><a href="#3-onInterceptTouchEvent" class="headerlink" title="3.onInterceptTouchEvent"></a>3.onInterceptTouchEvent</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</span><br><span class="line"> return false;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-TouchEvent"><a href="#4-TouchEvent" class="headerlink" title="4.TouchEvent"></a>4.TouchEvent</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Implement this method to handle touch screen motion events.</span><br><span class="line">* &lt;p&gt;</span><br><span class="line">* If this method is used to detect click actions, it is recommended that</span><br><span class="line">* the actions be performed by implementing and calling</span><br><span class="line">* &#123;@link #performClick()&#125;. This will ensure consistent system behavior,</span><br><span class="line">* including:</span><br><span class="line">* &lt;ul&gt;</span><br><span class="line">* &lt;li&gt;obeying click sound preferences</span><br><span class="line">* &lt;li&gt;dispatching OnClickListener calls</span><br><span class="line">* &lt;li&gt;handling &#123;@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</span><br><span class="line">* accessibility features are enabled</span><br><span class="line">* &lt;/ul&gt;</span><br><span class="line">*</span><br><span class="line">* @param event The motion event.</span><br><span class="line">* @return True if the event was handled, false otherwise.</span><br><span class="line">*/</span><br><span class="line">public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">final float x = event.getX();</span><br><span class="line">final float y = event.getY();</span><br><span class="line">final int viewFlags = mViewFlags;</span><br><span class="line">final int action = event.getAction();</span><br><span class="line"></span><br><span class="line">if ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</span><br><span class="line">setPressed(false);</span><br><span class="line">&#125;</span><br><span class="line">// A disabled view that is clickable still consumes the touch</span><br><span class="line">// events, it just doesn&apos;t respond to them.</span><br><span class="line">return (((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">|| (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">|| (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (mTouchDelegate != null) &#123;</span><br><span class="line">if (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">return true;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</span><br><span class="line">(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</span><br><span class="line">(viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</span><br><span class="line">switch (action) &#123;</span><br><span class="line">case MotionEvent.ACTION_UP:</span><br><span class="line">boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;</span><br><span class="line">if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) &#123;</span><br><span class="line">// take focus if we don&apos;t have it already and we should in</span><br><span class="line">// touch mode.</span><br><span class="line">boolean focusTaken = false;</span><br><span class="line">if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">focusTaken = requestFocus();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (prepressed) &#123;</span><br><span class="line">// The button is being released before we actually</span><br><span class="line">// showed it as pressed. Make it show the pressed</span><br><span class="line">// state now (before scheduling the click) to ensure</span><br><span class="line">// the user sees it.</span><br><span class="line">setPressed(true, x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">// This is a tap, so remove the longpress check</span><br><span class="line">removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">// Only perform take click actions if we were in the pressed state</span><br><span class="line">if (!focusTaken) &#123;</span><br><span class="line">// Use a Runnable and post this rather than calling</span><br><span class="line">// performClick directly. This lets other visual state</span><br><span class="line">// of the view update before click actions start.</span><br><span class="line">if (mPerformClick == null) &#123;</span><br><span class="line">mPerformClick = new PerformClick();</span><br><span class="line">&#125;</span><br><span class="line">if (!post(mPerformClick)) &#123;</span><br><span class="line">performClick();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (mUnsetPressedState == null) &#123;</span><br><span class="line">mUnsetPressedState = new UnsetPressedState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (prepressed) &#123;</span><br><span class="line">postDelayed(mUnsetPressedState,</span><br><span class="line">ViewConfiguration.getPressedStateDuration());</span><br><span class="line">&#125; else if (!post(mUnsetPressedState)) &#123;</span><br><span class="line">// If the post failed, unpress right now</span><br><span class="line">mUnsetPressedState.run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">removeTapCallback();</span><br><span class="line">&#125;</span><br><span class="line">mIgnoreNextUpEvent = false;</span><br><span class="line">break;</span><br><span class="line"></span><br><span class="line">case MotionEvent.ACTION_DOWN:</span><br><span class="line">mHasPerformedLongPress = false;</span><br><span class="line"></span><br><span class="line">if (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Walk up the hierarchy to determine if we&apos;re inside a scrolling container.</span><br><span class="line">boolean isInScrollingContainer = isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">// For views inside a scrolling container, delay the pressed feedback for</span><br><span class="line">// a short period in case this is a scroll.</span><br><span class="line">if (isInScrollingContainer) &#123;</span><br><span class="line">mPrivateFlags |= PFLAG_PREPRESSED;</span><br><span class="line">if (mPendingCheckForTap == null) &#123;</span><br><span class="line">mPendingCheckForTap = new CheckForTap();</span><br><span class="line">&#125;</span><br><span class="line">mPendingCheckForTap.x = event.getX();</span><br><span class="line">mPendingCheckForTap.y = event.getY();</span><br><span class="line">postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">&#125; else &#123;</span><br><span class="line">// Not inside a scrolling container, so show the feedback right away</span><br><span class="line">setPressed(true, x, y);</span><br><span class="line">checkForLongClick(0);</span><br><span class="line">&#125;</span><br><span class="line">break;</span><br><span class="line"></span><br><span class="line">case MotionEvent.ACTION_CANCEL:</span><br><span class="line">setPressed(false);</span><br><span class="line">removeTapCallback();</span><br><span class="line">removeLongPressCallback();</span><br><span class="line">mInContextButtonPress = false;</span><br><span class="line">mHasPerformedLongPress = false;</span><br><span class="line">mIgnoreNextUpEvent = false;</span><br><span class="line">break;</span><br><span class="line"></span><br><span class="line">case MotionEvent.ACTION_MOVE:</span><br><span class="line">drawableHotspotChanged(x, y);</span><br><span class="line"></span><br><span class="line">// Be lenient about moving outside of buttons</span><br><span class="line">if (!pointInView(x, y, mTouchSlop)) &#123;</span><br><span class="line">// Outside button</span><br><span class="line">removeTapCallback();</span><br><span class="line">if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</span><br><span class="line">// Remove any future long press/tap checks</span><br><span class="line">removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">setPressed(false);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/14/设计模式-责任链模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/14/设计模式-责任链模式/" itemprop="url">
                  设计模式-责任链模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-14T09:35:49+08:00">
                2017-02-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/14/设计模式-责任链模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/14/设计模式-责任链模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-责任链模式的定义及使用场景"><a href="#1-责任链模式的定义及使用场景" class="headerlink" title="1.责任链模式的定义及使用场景"></a>1.责任链模式的定义及使用场景</h2><h3 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h3><p>责任链模式是行为型设计模式之一。使多个对象都有机会处理请求，从而避免了请求的发送者和接受者之间的耦合关系。将这些对象连成一条链，并沿着这条链传递该请求，直到有对象处理它为止</p>
<p>###使用场景：<br>使多个对象都有机会处理请求，从而避免了请求的发送者和接收者之间的耦合关系。将这些对象连成一条链，并沿着这条链传递该请求，只到有对象处理它为止<br><img src="http://img.blog.csdn.net/20170214090047528?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="责任链模式"></p>
<h2 id="2-责任链模式的优缺点"><a href="#2-责任链模式的优缺点" class="headerlink" title="2 . 责任链模式的优缺点"></a>2 . 责任链模式的优缺点</h2><h3 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h3><p>责任链模式非常显著的优点是将请求和处理分开。请求者可以不用知道是谁处理，处理者可以不用知道请求的全貌，两者解耦，提高系统的灵活性</p>
<h3 id="2-2缺点"><a href="#2-2缺点" class="headerlink" title="2.2缺点"></a>2.2缺点</h3><p>责任链有两个非常显著的缺点：一是性能问题，每个请求都是从链头遍历到链尾，特别是在链比较长的时候，性能是一个比较大的问题；<br>二是调试不很方便，特别是链条比较长，环节比较多的时候，由于采用了类似递归的方式，调试的时候逻辑可能比较复杂</p>
<h2 id="3-注意实现"><a href="#3-注意实现" class="headerlink" title="3.注意实现"></a>3.注意实现</h2><p>链中节点数量需要控制，避免出现超长链的情况，一般的做法是在handler<br>中设置一个最大节点数量，在setNext方法中判断是否已经是超过其阈值，超过则不允许该链建立，避免无意识地破坏系统性能</p>
<h2 id="4-责任链模式的实现方式"><a href="#4-责任链模式的实现方式" class="headerlink" title="4. 责任链模式的实现方式"></a>4. 责任链模式的实现方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractRequest &#123;</span><br><span class="line">    private Object obj;//处理对象</span><br><span class="line"></span><br><span class="line">    public AbstractRequest(Object object) &#123;</span><br><span class="line">        this.obj = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getContent() &#123;</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //获取请求的级别</span><br><span class="line">    public abstract int getRequestLevel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractHandler &#123;</span><br><span class="line">    protected AbstractHandler nexthandler;//下一节点处理对象</span><br><span class="line"></span><br><span class="line">    public final void handleRequest(AbstractRequest request) &#123;</span><br><span class="line">        if(getHandleLevel()==request.getRequestLevel())&#123;</span><br><span class="line">            handle(request);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            if(nexthandler!=null)&#123;</span><br><span class="line">                nexthandler.handleRequest(request);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                System.out.println(&quot;All of handler can not handle the request&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //获取处理者对象的处理级别</span><br><span class="line">    protected abstract int getHandleLevel();</span><br><span class="line"></span><br><span class="line">    //每个处理者对象的具体处理方式</span><br><span class="line">    protected abstract void handle(AbstractRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Handler1 extends AbstractHandler &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected int getHandleLevel() &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void handle(AbstractRequest request) &#123;</span><br><span class="line">        System.out.println(&quot;Handler1 handle request:&quot;+request.getRequestLevel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Handler2 extends AbstractHandler &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected int getHandleLevel() &#123;</span><br><span class="line">        return 2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void handle(AbstractRequest request) &#123;</span><br><span class="line">        System.out.println(&quot;Handler2 handle request:&quot;+request.getRequestLevel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Handler3 extends AbstractHandler &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected int getHandleLevel() &#123;</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void handle(AbstractRequest request) &#123;</span><br><span class="line">        System.out.println(&quot;Handler3 handle request:&quot;+request.getRequestLevel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Request1 extends  AbstractRequest &#123;</span><br><span class="line">    public Request1(Object object) &#123;</span><br><span class="line">        super(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getRequestLevel() &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Request2 extends  AbstractRequest &#123;</span><br><span class="line">    public Request2(Object object) &#123;</span><br><span class="line">        super(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getRequestLevel() &#123;</span><br><span class="line">        return 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Request3 extends  AbstractRequest &#123;</span><br><span class="line">    public Request3(Object object) &#123;</span><br><span class="line">        super(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getRequestLevel() &#123;</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Request4 extends  AbstractRequest &#123;</span><br><span class="line">    public Request4(Object object) &#123;</span><br><span class="line">        super(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getRequestLevel() &#123;</span><br><span class="line">        return 4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String args[]) &#123;</span><br><span class="line">        AbstractHandler h1=new Handler1();</span><br><span class="line">        AbstractHandler h2=new Handler2();</span><br><span class="line">        AbstractHandler h3=new Handler3();</span><br><span class="line">        h1.nexthandler=h2;</span><br><span class="line">        h2.nexthandler=h3;</span><br><span class="line"></span><br><span class="line">        AbstractRequest r1=new Request1(h1);</span><br><span class="line">        AbstractRequest r2=new Request2(h2);</span><br><span class="line">        AbstractRequest r3=new Request3(h3);</span><br><span class="line">        AbstractRequest r4=new Request4(h3);</span><br><span class="line">        //总是从链式的首端发起请求</span><br><span class="line">        h1.handleRequest(r1);</span><br><span class="line">        h1.handleRequest(r2);</span><br><span class="line">        h1.handleRequest(r3);</span><br><span class="line">        h1.handleRequest(r4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-责任链模式在Android中的实际应用"><a href="#5-责任链模式在Android中的实际应用" class="headerlink" title="5. 责任链模式在Android中的实际应用"></a>5. 责任链模式在Android中的实际应用</h2><p>责任链模式在Android源码中比较类似的实现就是对于触摸事件的分发处理。每当用户接触屏幕时，Android都会将对应的事件包装成一个事件对象从ViewTree的顶部至上而下地分发传递。ViewGroup事件投递的递归调用就类似于一条责任链，一旦寻找到责任者，那么将由责任者持有并消费掉该次事件，具体地体现在View的onTouchEvent方法中返回值的设置，如果onTouchEvent返回false，那么意味着当前View不会是该次事件的复制人，将不会对其持有；如果为true则相反，此时View会持有该事件并不再向外传递。<br>View的事件分发机制（MontionEvent的分发过程）：<br>public boolean dispatchTouchEvent（MotionEvent ev）<br>如果事件能够传递到当前的View，那么此方法一定会被调用。<br>public boolean onInterceptTouchEvent（MotionEvent ev）<br>用来判断是否拦截某个事件<br>public boolean onTouchEvent(MotionEvent ev)<br>用来处理点击事件<br>流转关系（伪代码）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean dispatchTouchEvent(MotionEvent ev)&#123;</span><br><span class="line">     boolean consume=false;</span><br><span class="line">     if(onInterceptTouchEvent(ev))&#123;</span><br><span class="line">          consume=onTouchEvent(ev);</span><br><span class="line">     &#125;else&#123;</span><br><span class="line">          consume=child.dispatchTouchEvent(ev);</span><br><span class="line">     &#125;</span><br><span class="line">     return consume;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/08/设计模式-命令模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/08/设计模式-命令模式/" itemprop="url">
                  设计模式-命令模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-08T19:24:00+08:00">
                2017-02-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/08/设计模式-命令模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/08/设计模式-命令模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-命令模式的定义及使用场景"><a href="#1-命令模式的定义及使用场景" class="headerlink" title="1.命令模式的定义及使用场景"></a>1.命令模式的定义及使用场景</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>命令模式是行为型设计模式之一。将一个请求封装成一个对象，从而让用户使用不同的请求把客户端参数化；对请求排队或者记录请求日志，以支持可撤销的操作</p>
<h2 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h2><ul>
<li><p>需要抽象出待执行的动作，然后以参数的形式提供出来，类似于过程设计中的回调机制，而命令模式正是回调机制的一个面向对象的替代品。<br>在不同的时刻指定、排列和执行请求。一个命令对象可以有与初始请求无关的生存期。</p>
</li>
<li><p>需要支持取消操作。</p>
</li>
<li>支持修改日志功能，这样当系统奔溃时，这些修改可以被重做一遍。</li>
<li>需要支持事务操作。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20170208192136610?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="2-命令模式的优缺点"><a href="#2-命令模式的优缺点" class="headerlink" title="2. 命令模式的优缺点"></a>2. 命令模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><ul>
<li>类间解耦<br>调用者角色与接受者角色之间没有任何依赖关系，调用者实现功能时只需要调用Command抽象类的execute方法就可以，不需要了解到底是那个接受者执行</li>
<li>可扩展性<br>Command的子类可以非常容易地扩展，而调用者Invoker和高层次的模块Client不产生严重的代码耦合</li>
<li>命令模式结合其他模式会更优秀<br>命令模式可以结合责任链模式，实现命令族解析任务；结合模板方法模式，则可以减少Command子类的膨胀问题<h2 id="2-2缺点"><a href="#2-2缺点" class="headerlink" title="2.2缺点"></a>2.2缺点</h2>命令模式也是有缺点的，请看Command的子类；如果有N个命令，问题就出来了，Command的子类就可不是几个，而是N个，这个类膨胀得非常大，这个就需要读者在项目中慎重考虑<h1 id="3-注意事项"><a href="#3-注意事项" class="headerlink" title="3.注意事项"></a>3.注意事项</h1>对于命令模式，大家可能 心存疑虑，明明是一个很简单的调用逻辑，为什么要做如此的复杂，为什么不直接reciver的excute方法就可以实现功能？<br>调用逻辑复杂，是为了如果后续命令的增加， 能够应对后续需求的变化。简单的只是开发起来方便，但对后续的维护则是困难。<br>除此之外，使用命令模式的另一个好处是可以实现命令记录的功能，可以在调用者里面使用一个数据结构来存储执行过的命令对象，以此可以方便地知道刚刚执行过哪些命令，并可以在需要是恢复。并且可以在调用者中执行日志的记录。<h1 id="4-命令模式的实现方式"><a href="#4-命令模式的实现方式" class="headerlink" title="4. 命令模式的实现方式"></a>4. 命令模式的实现方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Command &#123;  </span><br><span class="line">    //执行具体操作命令  </span><br><span class="line">    public  abstract void execute();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteCommand1 extends Command &#123;  </span><br><span class="line">    private  Receiver receiver;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public ConcreteCommand1() &#123;  </span><br><span class="line">        this.receiver = new ConcreteReceiver1();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setReceiver(Receiver receiver) &#123;  </span><br><span class="line">        this.receiver = receiver;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void execute() &#123;  </span><br><span class="line">        if(receiver!=null)&#123;  </span><br><span class="line">            receiver.doSomething();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteCommand2 extends Command &#123;  </span><br><span class="line">    private  Receiver receiver;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public ConcreteCommand2() &#123;  </span><br><span class="line">        this.receiver = new ConcreteReceiver2();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setReceiver(Receiver receiver) &#123;  </span><br><span class="line">        this.receiver = receiver;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void execute() &#123;  </span><br><span class="line">        if(receiver!=null)&#123;  </span><br><span class="line">            receiver.doSomething();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract  class Receiver &#123;  </span><br><span class="line">    public abstract void doSomething();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteReceiver1 extends Receiver &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void doSomething() &#123;  </span><br><span class="line">        System.out.println(&quot;ConcreteReceiver1 do...&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteReceiver2 extends Receiver &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void doSomething() &#123;  </span><br><span class="line">        System.out.println(&quot;ConcreteReceiver2 do...&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Invoker &#123;  </span><br><span class="line">    private Command command;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setCommand(Command command) &#123;  </span><br><span class="line">        this.command = command;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void action() &#123;  </span><br><span class="line">        this.command.execute();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public static void main(String args[]) &#123;  </span><br><span class="line">        Invoker invoker = new Invoker();  </span><br><span class="line">        Receiver receiver = new ConcreteReceiver1();  </span><br><span class="line">        Command command = new ConcreteCommand1();  </span><br><span class="line">        invoker.setCommand(command);  </span><br><span class="line">        invoker.action();  </span><br><span class="line">        Receiver receiver2 = new ConcreteReceiver2();  </span><br><span class="line">        Command command2 = new ConcreteCommand2();  </span><br><span class="line">        invoker.setCommand(command2);  </span><br><span class="line">        invoker.action();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/07/设计模式-中介者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/07/设计模式-中介者模式/" itemprop="url">
                  设计模式-中介者模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-07T09:04:26+08:00">
                2017-02-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/07/设计模式-中介者模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/07/设计模式-中介者模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-中介者模式的定义及使用场景"><a href="#1-中介者模式的定义及使用场景" class="headerlink" title="1.中介者模式的定义及使用场景"></a>1.中介者模式的定义及使用场景</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>中介者模式包装了一系列对象相互作用的方式，使得这些对象不必相互明显作用。从而使他们可以松散耦合。当某些对象之间的作用发生改变时，不会立即影响其他的一些对象之间的作用。保证这些作用可以彼此独立的变化。中介者模式将多对多的相互作用转化为一对多的相互作用。中介者模式将对象的行为和协作抽象化，把对象在小尺度的行为上与其他对象的相互作用分开处理。</p>
<h2 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h2><p>当对象之间的交互操作很多且每个对象的行为操作都彼此依赖时，为防止在修改一个对象的行为时，同时涉及修改很多其他对象的行为，可采用中介者模式，来解决紧耦合问题。该模式将对象之间的多对多关系变成一对多关系，中介者对象将系统从网状结构变成以调停者为中心的星形结构，达到降低系统的复杂性，提高可扩展的作用。</p>
<p><img src="http://img.blog.csdn.net/20170207090120031?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="2-中介者模式的优缺点"><a href="#2-中介者模式的优缺点" class="headerlink" title="2.中介者模式的优缺点"></a>2.中介者模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><p>中介者的模式的优点就是减少类间的依赖，把原有的一对多的依赖变成一对一的依赖，同事类只依赖中介者，减少依赖，当然同时也降低了类间的耦合</p>
<p>##2.2缺点<br>中介者模式的缺点就是中介者会膨胀得很大，而且逻辑复杂，原本N个对象直接的相互依赖关系转换为中介者和同事类的依赖关系，同事类约多，中介者的逻辑就越复杂</p>
<h1 id="3-注意实现"><a href="#3-注意实现" class="headerlink" title="3.注意实现"></a>3.注意实现</h1><p>中介者模式是一个非常好的封装模式，也是一个很容易被滥用的模式，一个对象依赖几个对象是再正常不过的事情，但是纯理论家就会要求使用中介者模式来封装这种依赖关系，这是非常危险的！使用中介者模式就必然会带来中介者的膨胀问题，这在一个项目中是很不恰当的。可以在如下的情况尝试使用中介者模式：</p>
<ul>
<li>N个对象直接产生了相互的依赖关系（N&gt;2）</li>
<li>对个对象有依赖关系，但是依赖的行为尚不确定或者有发送改变的可能，在这种情况下一般建议采用中介者模式，降低变更引起的风险扩散</li>
<li>产品开发。一个明显的例子就是MVC框架，把中介者模式应用到产品中，可以提升产品的性能扩展性，但是对于项目开发就未必，因为项目是以交付投产为目标，而产品是以稳定、高效、扩展为宗旨。<h1 id="4-中介者模式的实现方式"><a href="#4-中介者模式的实现方式" class="headerlink" title="4.中介者模式的实现方式"></a>4.中介者模式的实现方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Colleague &#123;  </span><br><span class="line">    Mediator mediator;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public Colleague(Mediator mediator) &#123;  </span><br><span class="line">        this.mediator = mediator;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public abstract void action();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteColleagueA extends Colleague &#123;  </span><br><span class="line">    public ConcreteColleagueA(Mediator mediator) &#123;  </span><br><span class="line">        super(mediator);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void action() &#123;  </span><br><span class="line">        System.out.println(&quot;ColleagueA do action!&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void doPrivateA() &#123;  </span><br><span class="line">        System.out.println(&quot;ColleagueA do private!&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteColleagueB extends Colleague &#123;  </span><br><span class="line">    public ConcreteColleagueB(Mediator mediator) &#123;  </span><br><span class="line">        super(mediator);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void action() &#123;  </span><br><span class="line">        System.out.println(&quot;ColleagueB do action!&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void doPrivateB() &#123;  </span><br><span class="line">        System.out.println(&quot;ColleagueB do private!&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> public abstract class Mediator &#123;  </span><br><span class="line">    protected ConcreteColleagueA concreteColleagueA;  </span><br><span class="line">    protected  ConcreteColleagueB concreteColleagueB;  </span><br><span class="line">    public abstract void method();  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setConcreteColleagueA(ConcreteColleagueA concreteColleagueA) &#123;  </span><br><span class="line">        this.concreteColleagueA = concreteColleagueA;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setConcreteColleagueB(ConcreteColleagueB concreteColleagueB) &#123;  </span><br><span class="line">        this.concreteColleagueB = concreteColleagueB;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class ConcreteMediator extends Mediator &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void method() &#123;  </span><br><span class="line">        concreteColleagueA.action();  </span><br><span class="line">        concreteColleagueB.action();  </span><br><span class="line">        concreteColleagueA.doPrivateA();  </span><br><span class="line">        concreteColleagueB.doPrivateB();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-中介者模式在Android中的实际应用"><a href="#5-中介者模式在Android中的实际应用" class="headerlink" title="5.中介者模式在Android中的实际应用"></a>5.中介者模式在Android中的实际应用</h1><p>Android的Activity实际就是一个中介者模式，形形式式的View交互都在Activity中统一执行，View之间彼此不交互。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/06/设计模式-原型模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/06/设计模式-原型模式/" itemprop="url">
                  设计模式-原型模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-06T08:40:17+08:00">
                2017-02-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/06/设计模式-原型模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/06/设计模式-原型模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-原型模式的定义及使用场景"><a href="#1-原型模式的定义及使用场景" class="headerlink" title="1.原型模式的定义及使用场景"></a>1.原型模式的定义及使用场景</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>用原型实例指定创建对象的种类，并通过拷贝这些原型创建新的对象</p>
<h2 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h2><ul>
<li>类初始化需要消耗非常多的资源，这个资源包括数据、硬件资源等，通过原型拷贝避免这些消耗</li>
<li>通过new产生一个对象需要非常繁琐的数据准备或访问权限，这时可以使用原型模式</li>
<li>一个对象需要提供给其他对象访问，而且各个调用者可能都需要修改其值时，可以考虑使用原型模式拷贝多个对象供调用者使用，即保护性拷贝</li>
</ul>
<p><img src="http://img.blog.csdn.net/20170206083811700?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="2-原型模式的优缺点"><a href="#2-原型模式的优缺点" class="headerlink" title="2.原型模式的优缺点"></a>2.原型模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><p><strong>性能优良</strong><br>原型模式是在内存二进制流的拷贝，要比直接new一个对象性能好，特别是要在一个循环体内产生大量的对象时，原型模式可以更好地体现其优点</p>
<h2 id="2-2缺点"><a href="#2-2缺点" class="headerlink" title="2.2缺点"></a>2.2缺点</h2><p><strong>逃避构造函数的约束</strong><br>这既是他的优点也是缺点，直接在内存中拷贝，构造函数不会执行。需要在实际应用时考虑</p>
<h1 id="3-注意实现"><a href="#3-注意实现" class="headerlink" title="3.注意实现"></a>3.注意实现</h1><ul>
<li>构造函数默认不执行</li>
<li>浅拷贝及深拷贝</li>
<li>Object类提供的方法clone只是拷贝本对象，其对象内部的数组、引用对象等都不拷贝，还是指向原型对象的内部元素地址，这种拷贝为浅拷贝。如需要深拷贝，对应的成员也需指向clone方法</li>
<li>要使用clone方法，类的成员变量上不要增加final关键字<h1 id="4-原型模式的实现方式"><a href="#4-原型模式的实现方式" class="headerlink" title="4.原型模式的实现方式"></a>4.原型模式的实现方式</h1></li>
</ul>
<p>ProtoType：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class ProtoType implements Cloneable &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public ProtoType() &#123;  </span><br><span class="line">        System.out.println(&quot;ProtoType is excute...&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    private int id;  </span><br><span class="line">    private String name;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public int getId() &#123;  </span><br><span class="line">        return id;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setId(int id) &#123;  </span><br><span class="line">        this.id = id;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public String getName() &#123;  </span><br><span class="line">        return name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setName(String name) &#123;  </span><br><span class="line">        this.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    protected ProtoType clone() &#123;  </span><br><span class="line">        ProtoType protoType = null;  </span><br><span class="line">        try &#123;  </span><br><span class="line">            protoType = (ProtoType) super.clone();  </span><br><span class="line">        &#125; catch (CloneNotSupportedException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        return protoType;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public String toString() &#123;  </span><br><span class="line">        return &quot;ProtoType&#123;&quot; +  </span><br><span class="line">                &quot;id=&quot; + id +  </span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +  </span><br><span class="line">                &apos;&#125;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Text：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public static void main(String args[]) &#123;  </span><br><span class="line">        ProtoType type = new ProtoType();  </span><br><span class="line">        type.setId(1);  </span><br><span class="line">        type.setName(&quot;张三&quot;);  </span><br><span class="line">        System.out.println(type);  </span><br><span class="line">        ProtoType clone = type.clone();  </span><br><span class="line">        clone.setId(2);  </span><br><span class="line">        clone.setName(&quot;李四&quot;);  </span><br><span class="line">        System.out.println(clone);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Objec的clone源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/** </span><br><span class="line">* Creates and returns a copy of this &#123;@code Object&#125;. The default </span><br><span class="line">* implementation returns a so-called &quot;shallow&quot; copy: It creates a new </span><br><span class="line">* instance of the same class and then copies the field values (including </span><br><span class="line">* object references) from this instance to the new instance. A &quot;deep&quot; copy, </span><br><span class="line">* in contrast, would also recursively clone nested objects. A subclass that </span><br><span class="line">* needs to implement this kind of cloning should call &#123;@code super.clone()&#125; </span><br><span class="line">* to create the new instance and then create deep copies of the nested, </span><br><span class="line">* mutable objects. </span><br><span class="line">* </span><br><span class="line">* @return a copy of this object. </span><br><span class="line">* @throws CloneNotSupportedException </span><br><span class="line">* if this object&apos;s class does not implement the &#123;@code </span><br><span class="line">* Cloneable&#125; interface. </span><br><span class="line">*/  </span><br><span class="line">protected Object clone() throws CloneNotSupportedException &#123;  </span><br><span class="line">if (!(this instanceof Cloneable)) &#123;  </span><br><span class="line">throw new CloneNotSupportedException(&quot;Class &quot; + getClass().getName() +  </span><br><span class="line">&quot; doesn&apos;t implement Cloneable&quot;);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">return internalClone();  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* </span><br><span class="line">* Native helper method for cloning. </span><br><span class="line">*/  </span><br><span class="line">private native Object internalClone();</span><br></pre></td></tr></table></figure></p>
<p>可见执行了一个native方法执行二进制流的拷贝</p>
<h1 id="5-原型模式在Android中的实际应用"><a href="#5-原型模式在Android中的实际应用" class="headerlink" title="5.原型模式在Android中的实际应用"></a>5.原型模式在Android中的实际应用</h1><p>Intent：  </p>
<pre><code> @Override  
 public Object clone() {  
 return new Intent(this);  
 }  


/** 
 * Copy constructor. 
 */  
 public Intent(Intent o) {  
 this.mAction = o.mAction;  
 this.mData = o.mData;  
 this.mType = o.mType;  
 this.mPackage = o.mPackage;  
 this.mComponent = o.mComponent;  
 this.mFlags = o.mFlags;  
 this.mContentUserHint = o.mContentUserHint;  
 if (o.mCategories != null) {  
 this.mCategories = new ArraySet&lt;String&gt;(o.mCategories);  
 }  
 if (o.mExtras != null) {  
 this.mExtras = new Bundle(o.mExtras);  
 }  
 if (o.mSourceBounds != null) {  
 this.mSourceBounds = new Rect(o.mSourceBounds);  
 }  
 if (o.mSelector != null) {  
 this.mSelector = new Intent(o.mSelector);  
 }  
 if (o.mClipData != null) {  
 this.mClipData = new ClipData(o.mClipData);  
 }  
 }  
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/02/03/设计模式-代理模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/03/设计模式-代理模式/" itemprop="url">
                  设计模式-代理模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-03T09:47:06+08:00">
                2017-02-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/03/设计模式-代理模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/03/设计模式-代理模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-代理模式的定义及使用场景"><a href="#1-代理模式的定义及使用场景" class="headerlink" title="1.代理模式的定义及使用场景"></a>1.代理模式的定义及使用场景</h1><p>代理模式也是委托模式，是结构型设计模式。</p>
<h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>为其他对象提供一种代理以控制对这个对象的访问</p>
<h2 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h2><p>当无法或不想直接访问某个对象或者访问某个对象存在困难时或者在访问某个对象的前后需要执行一些约定的方法，可以通过一个代理对象来间接访问，为了保证客户端使用的透明性，委托对象与代理对象需要实现相同的接口</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB5dc935e88b6e1a45f07e01aebb3fa122?method=getImage&amp;cstk=5KZaknv3" alt="image"> </p>
<h1 id="2-代理模式的优缺点"><a href="#2-代理模式的优缺点" class="headerlink" title="2.代理模式的优缺点"></a>2.代理模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><ul>
<li>职责清晰：真实的角色就是实现实际的业务逻辑，不用关心其他非本职的事务，通过后期的代理完成一件事务</li>
<li>高扩展性：具体主题角色是随时都会变化，只要实现了接口，代理类完成就可以在不做任务修改的情况下使用</li>
<li>使用动态代理，提高智能化<h2 id="2-3缺点"><a href="#2-3缺点" class="headerlink" title="2.3缺点"></a>2.3缺点</h2>产生多余的类对象，增加结构复杂性<h1 id="3-代理模式的实现方式"><a href="#3-代理模式的实现方式" class="headerlink" title="3.代理模式的实现方式"></a>3.代理模式的实现方式</h1>#3.1静态代理</li>
</ul>
<p>Subject：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface  Subject &#123;  </span><br><span class="line">    public  void visit();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>RealSubject：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class RealSubject implements   Subject &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void visit() &#123;  </span><br><span class="line">        System.out.println(&quot;RealSubject:do something&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ProxySubject：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class ProxySubject &#123;  </span><br><span class="line">  </span><br><span class="line">    Subject subject;  </span><br><span class="line">  </span><br><span class="line">    public void setSubject(Subject subject) &#123;  </span><br><span class="line">        this.subject = subject;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public void visit() &#123;  </span><br><span class="line">        befrore();//预处理  </span><br><span class="line">        subject.visit();  </span><br><span class="line">        after();//善后处理  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public void  befrore()&#123;  </span><br><span class="line">        System.out.println(&quot;proxy before&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public  void after()&#123;  </span><br><span class="line">        System.out.println(&quot;proxy after&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-2动态代理"><a href="#3-2动态代理" class="headerlink" title="3.2动态代理"></a>3.2动态代理</h2><p>IAdvice：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface IAdvice &#123;  </span><br><span class="line">    public void exce();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>BeforeAdvice:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class BeforeAdvice implements  IAdvice &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void exce() &#123;  </span><br><span class="line">        System.out.println(&quot;BeforeAdvice exec...&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MyInvocationHandler:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class MyInvocationHandler implements InvocationHandler &#123;  </span><br><span class="line">    private Object target;  </span><br><span class="line">  </span><br><span class="line">    public MyInvocationHandler(Object target) &#123;  </span><br><span class="line">        this.target = target;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;  </span><br><span class="line">        return method.invoke(target,args);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DynamicProxy:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class DynamicProxy&lt;T&gt; &#123;  </span><br><span class="line">    public static &lt;T&gt; T newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler handler) &#123;  </span><br><span class="line">        new BeforeAdvice().exce();  </span><br><span class="line">        return  (T)Proxy.newProxyInstance(loader, interfaces, handler);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/01/19/Android之Context底层原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/19/Android之Context底层原理/" itemprop="url">
                  Android之Context底层原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-19T10:00:39+08:00">
                2017-01-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/19/Android之Context底层原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/19/Android之Context底层原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-Context基本概念"><a href="#1-Context基本概念" class="headerlink" title="1.Context基本概念"></a>1.Context基本概念</h1><p>Context的中文翻译为：语境; 上下文; 背景; 环境，在开发中我们经常说称之为“上下文”。从Android系统的角度来理解：Context是一个场景，代表与操作系统的交互的一种过程。Context在加载资源、启动Activity、获取系统服务、创建View等操作都要参与  。从程序的角度上来理解：Context是个抽象类，而Activity、Service、Application等都是该类的一个实现。</p>
<h1 id="2-Context与Activity、Service、Application关系"><a href="#2-Context与Activity、Service、Application关系" class="headerlink" title="2.Context与Activity、Service、Application关系"></a>2.Context与Activity、Service、Application关系</h1><p><img src="http://img.blog.csdn.net/20170119095448703?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<p>Context类本身是一个纯abstract类，他有两个具体的实现子类：ContextImpl和ContextWrapper。其中ContextWrapper类，只是一个包装而已，ContextWrapper构造函数中必须包含一个真正的Context引用，同时ContextWrapper提供了attachBaseContext（）用于给ContextWrapper对象中指定真正的Context对象，调用ContextWrapper的方法都会被转向其所包含的真正的Context对象。<br>ContextThemeWrapper类，其内部包含了与主题（Theme）相关的接口，这里所说的主题就是指在AndroidMainifest.xml中通过android：theme为Application元素或者Activity元素指定的主题。当然，只有Activity才需要主题，Service是不需要主题的，Application同理。<br>而ContextImpl类则真正实现了Context中的所有函数，应用程序中所调用的各种Context类的方法，其实现均来于该类。Context的两个子类分工明确，其中ContextImpl是Context的具体实现类，ContextWrapper是Context的包装类。</p>
<h1 id="3-Context作用域"><a href="#3-Context作用域" class="headerlink" title="3.Context作用域"></a>3.Context作用域</h1><p><img src="http://img.blog.csdn.net/20170119095507953?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt><br>Activity的作用域最广，Application和Service在启动Activity需要创建一个新的task，一般不推荐。layout infalte也是合法的，但是会使用系统默认的主题样式，如果自定义某些样式可能不会被使用</p>
<h1 id="4-Context的使用"><a href="#4-Context的使用" class="headerlink" title="4.Context的使用"></a>4.Context的使用</h1><h2 id="4-1Context的数量"><a href="#4-1Context的数量" class="headerlink" title="4.1Context的数量"></a>4.1Context的数量</h2><p>一个应用程序中到底有多少个Context呢？根据Context的类型可以得出，一共有Application、Activity和Service三种类型，因此一个应用程序的Context数量为：<br>Context数量=Activity数量+Service数量+1</p>
<h2 id="4-2如何获取Context"><a href="#4-2如何获取Context" class="headerlink" title="4.2如何获取Context"></a>4.2如何获取Context</h2><p>1）View.getContext,返回当前Activity所在的应用进程的Context对象，通常是当前正在展示的Activity对象<br>2）Activity.getApplicationContext,获取当前Activity所在的（应用）进程的Context对象，通常我们使用Context对象时，要优先考虑这个全局的进程Context。<br>3）Activity.this返回当前的Activity实例，如果是UI控件需要使用Activity作为Context对象，但是默认的Toast因为是系统层级的Windows，直接使用ApplicationContext则可。<br>4）getApplication和getApplicationContext获取的对象时一致的。但是getApplication方法只有在Activity和Service中才能调到。但例如BroadcasrReceiver中需要获取Application，则需要借助getApplicationContext（）方法。</p>
<h2 id="4-3Context引起的内测泄漏"><a href="#4-3Context引起的内测泄漏" class="headerlink" title="4.3Context引起的内测泄漏"></a>4.3Context引起的内测泄漏</h2><p>1）错误的单例模式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">    private static Singleton instance;  </span><br><span class="line">    private Context mContext;  </span><br><span class="line">  </span><br><span class="line">    private Singleton(Context context) &#123;  </span><br><span class="line">        this.mContext = context;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public static Singleton getInstance(Context context) &#123;  </span><br><span class="line">        if (instance == null) &#123;  </span><br><span class="line">            instance = new Singleton(context);  </span><br><span class="line">        &#125;  </span><br><span class="line">        return instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即使Activity被销毁掉，但因为它的引用还存在于一个Singleton中，就不可能被GC掉<br>2）View持有Activity引用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends Activity &#123;  </span><br><span class="line">    private static Drawable mDrawable;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    protected void onCreate(Bundle saveInstanceState) &#123;  </span><br><span class="line">        super.onCreate(saveInstanceState);  </span><br><span class="line">        setContentView(R.layout.activity_main);  </span><br><span class="line">        ImageView iv = new ImageView(this);  </span><br><span class="line">        mDrawable = getResources().getDrawable(R.drawable.ic_launcher);  </span><br><span class="line">        iv.setImageDrawable(mDrawable);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有一个静态的Drawable对象当ImageView设置这个Drawable时，ImageView保存了mDrawable的引用，而ImageView传入的this是MainActivity的mContext，因为被static修饰的mDrawable是常驻内存的，MainActivity是它的间接引用，MainActivity被销毁时，也不能被GC掉，所以造成内存泄漏。</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h1><ul>
<li>尽量使用Application的Context</li>
<li>不要让生命周期长于Activity的对象持有其的引用</li>
<li>尽量不要在Activity中使用非静态内部类，因为非静态内部类会隐式持有外部类示例的引用，如果使用静态内部类，将外部实例引用作为弱引用持有</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/01/18/设计模式-建造者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/18/设计模式-建造者模式/" itemprop="url">
                  设计模式-建造者模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-18T10:14:54+08:00">
                2017-01-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/18/设计模式-建造者模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/18/设计模式-建造者模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-建造者模式的定义及使用场景"><a href="#1-建造者模式的定义及使用场景" class="headerlink" title="1.建造者模式的定义及使用场景"></a>1.建造者模式的定义及使用场景</h1><p>Builder模式是一步一步创建一个复制对象的创建型模式，他允许用户在不知道内部构建细节的情况下，可以更精细地控制对象的构造流程。改模式是为了将构造复杂对象的过程和它的部件解耦，使得构建过程和部件的表示隔离开来。</p>
<h2 id="1-1定义"><a href="#1-1定义" class="headerlink" title="1.1定义"></a>1.1定义</h2><p>将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建同步的表示</p>
<h2 id="1-2使用场景"><a href="#1-2使用场景" class="headerlink" title="1.2使用场景"></a>1.2使用场景</h2><p>相同的方法，不同的执行顺序，产生不同的事件结果时<br>多个部件或零件，都可以装配到一个对象中，但是产生的运行结果又不相同时<br>产品类非常复杂，或者产品类中的调用顺序不同产生了不同的作用，这个时候使用建造者模式非常合适<br>当初始化一个对象特别复杂，如参数多，而且很多参数都具有默认值时</p>
<p><img src="http://img.blog.csdn.net/20170118100751791?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="2-建造者模式的优缺点"><a href="#2-建造者模式的优缺点" class="headerlink" title="2.建造者模式的优缺点"></a>2.建造者模式的优缺点</h1><h2 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h2><ul>
<li>封装性</li>
<li>建造者独立，容易扩展</li>
<li>便于控制细节风险<h2 id="2-2缺点"><a href="#2-2缺点" class="headerlink" title="2.2缺点"></a>2.2缺点</h2>会产生多余的Builder对象以及Director对象<h1 id="3-建造者模式的实现方式"><a href="#3-建造者模式的实现方式" class="headerlink" title="3.建造者模式的实现方式"></a>3.建造者模式的实现方式</h1>Product：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class Product &#123;  </span><br><span class="line">    private  int id;  </span><br><span class="line">    private  String  name;  </span><br><span class="line">    public void doSomeThing()&#123;  </span><br><span class="line">        System.out.println(&quot;Product doSomeThing id:&quot;+id+&quot; name:&quot;+name);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setId(int id) &#123;  </span><br><span class="line">        this.id = id;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void setName(String name) &#123;  </span><br><span class="line">        this.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public String toString() &#123;  </span><br><span class="line">        return &quot;Product&#123;&quot; +  </span><br><span class="line">                &quot;id=&quot; + id +  </span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +  </span><br><span class="line">                &apos;&#125;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>AbstactBuilder:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstactBulider &#123;  </span><br><span class="line">    abstract void setId(int id);  </span><br><span class="line">    abstract void setName(String name);  </span><br><span class="line">    abstract Product build();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Builder:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class Builder extends AbstactBulider &#123;  </span><br><span class="line">    Product product = new Product();  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    void setId(int id) &#123;  </span><br><span class="line">        product.setId(id);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    void setName(String name) &#123;  </span><br><span class="line">        product.setName(name);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    Product build() &#123;  </span><br><span class="line">        return product;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Director:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Director &#123;  </span><br><span class="line">    private AbstactBulider aBuilder, bBuilder;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public Product getAProduct() &#123;  </span><br><span class="line">        aBuilder = new Builder();  </span><br><span class="line">        aBuilder.setId(1);  </span><br><span class="line">        aBuilder.setName(&quot;allen&quot;);  </span><br><span class="line">        return aBuilder.build();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public Product getBProduct() &#123;  </span><br><span class="line">        bBuilder = new Builder();  </span><br><span class="line">        bBuilder.setId(2);  </span><br><span class="line">        bBuilder.setName(&quot;joy&quot;);  </span><br><span class="line">        return bBuilder.build();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="4-建造者模式在Android中的实际应用"><a href="#4-建造者模式在Android中的实际应用" class="headerlink" title="4.建造者模式在Android中的实际应用"></a>4.建造者模式在Android中的实际应用</h1><p>在Android源码中，最常用到的Builder模式就是AlertDialog.Builder，使用该Builder来构建复杂的AlertDialog对象。在开发过程中，我们经常用到AlertDialog，具体示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">new AlertDialog.Builder(self)</span><br><span class="line">  .setTitle(&quot;列表框&quot;)</span><br><span class="line">  .setItems(new String[] &#123;&quot;列表项1&quot;,&quot;列表项2&quot;,&quot;列表项3&quot;&#125;, null)</span><br><span class="line">  .setNegativeButton(&quot;确定&quot;, null)</span><br><span class="line">  .show();</span><br></pre></td></tr></table></figure></p>
<p>从类名就可以看出这是一个Builder模式，通过Builder对象来组装Dialog的各个部分，如title、buttons、items等。分析AlertDialog源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line">public static class Builder &#123;  </span><br><span class="line"> private final AlertController.AlertParams P;  </span><br><span class="line"> public Builder(Context context) &#123;  </span><br><span class="line"> this(context, resolveDialogTheme(context, 0));  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder(Context context, int themeResId) &#123;  </span><br><span class="line"> P = new AlertController.AlertParams(new ContextThemeWrapper(  </span><br><span class="line"> context, resolveDialogTheme(context, themeResId)));  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Context getContext() &#123;  </span><br><span class="line"> return P.mContext;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setTitle(@StringRes int titleId) &#123;  </span><br><span class="line"> P.mTitle = P.mContext.getText(titleId);  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setTitle(CharSequence title) &#123;  </span><br><span class="line"> P.mTitle = title;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setCustomTitle(View customTitleView) &#123;  </span><br><span class="line"> P.mCustomTitleView = customTitleView;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setMessage(@StringRes int messageId) &#123;  </span><br><span class="line"> P.mMessage = P.mContext.getText(messageId);  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setMessage(CharSequence message) &#123;  </span><br><span class="line"> P.mMessage = message;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setIcon(@DrawableRes int iconId) &#123;  </span><br><span class="line"> P.mIconId = iconId;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setIcon(Drawable icon) &#123;  </span><br><span class="line"> P.mIcon = icon;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setIconAttribute(@AttrRes int attrId) &#123;  </span><br><span class="line"> TypedValue out = new TypedValue();  </span><br><span class="line"> P.mContext.getTheme().resolveAttribute(attrId, out, true);  </span><br><span class="line"> P.mIconId = out.resourceId;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setPositiveButton(@StringRes int textId, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mPositiveButtonText = P.mContext.getText(textId);  </span><br><span class="line"> P.mPositiveButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setPositiveButton(CharSequence text, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mPositiveButtonText = text;  </span><br><span class="line"> P.mPositiveButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setNegativeButton(@StringRes int textId, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mNegativeButtonText = P.mContext.getText(textId);  </span><br><span class="line"> P.mNegativeButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setNegativeButton(CharSequence text, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mNegativeButtonText = text;  </span><br><span class="line"> P.mNegativeButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setNeutralButton(@StringRes int textId, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mNeutralButtonText = P.mContext.getText(textId);  </span><br><span class="line"> P.mNeutralButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setNeutralButton(CharSequence text, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mNeutralButtonText = text;  </span><br><span class="line"> P.mNeutralButtonListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line"> public Builder setCancelable(boolean cancelable) &#123;  </span><br><span class="line"> P.mCancelable = cancelable;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setOnCancelListener(OnCancelListener onCancelListener) &#123;  </span><br><span class="line"> P.mOnCancelListener = onCancelListener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line"> public Builder setOnDismissListener(OnDismissListener onDismissListener) &#123;  </span><br><span class="line"> P.mOnDismissListener = onDismissListener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setOnKeyListener(OnKeyListener onKeyListener) &#123;  </span><br><span class="line"> P.mOnKeyListener = onKeyListener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setItems(@ArrayRes int itemsId, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mItems = P.mContext.getResources().getTextArray(itemsId);  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setItems(CharSequence[] items, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mItems = items;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setAdapter(final ListAdapter adapter, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mAdapter = adapter;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setCursor(final Cursor cursor, final OnClickListener listener,  </span><br><span class="line"> String labelColumn) &#123;  </span><br><span class="line"> P.mCursor = cursor;  </span><br><span class="line"> P.mLabelColumn = labelColumn;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setMultiChoiceItems(@ArrayRes int itemsId, boolean[] checkedItems,  </span><br><span class="line"> final OnMultiChoiceClickListener listener) &#123;  </span><br><span class="line"> P.mItems = P.mContext.getResources().getTextArray(itemsId);  </span><br><span class="line"> P.mOnCheckboxClickListener = listener;  </span><br><span class="line"> P.mCheckedItems = checkedItems;  </span><br><span class="line"> P.mIsMultiChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setMultiChoiceItems(CharSequence[] items, boolean[] checkedItems,  </span><br><span class="line"> final OnMultiChoiceClickListener listener) &#123;  </span><br><span class="line"> P.mItems = items;  </span><br><span class="line"> P.mOnCheckboxClickListener = listener;  </span><br><span class="line"> P.mCheckedItems = checkedItems;  </span><br><span class="line"> P.mIsMultiChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setMultiChoiceItems(Cursor cursor, String isCheckedColumn, String labelColumn,  </span><br><span class="line"> final OnMultiChoiceClickListener listener) &#123;  </span><br><span class="line"> P.mCursor = cursor;  </span><br><span class="line"> P.mOnCheckboxClickListener = listener;  </span><br><span class="line"> P.mIsCheckedColumn = isCheckedColumn;  </span><br><span class="line"> P.mLabelColumn = labelColumn;  </span><br><span class="line"> P.mIsMultiChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setSingleChoiceItems(@ArrayRes int itemsId, int checkedItem,  </span><br><span class="line"> final OnClickListener listener) &#123;  </span><br><span class="line"> P.mItems = P.mContext.getResources().getTextArray(itemsId);  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> P.mCheckedItem = checkedItem;  </span><br><span class="line"> P.mIsSingleChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setSingleChoiceItems(Cursor cursor, int checkedItem, String labelColumn,  </span><br><span class="line"> final OnClickListener listener) &#123;  </span><br><span class="line"> P.mCursor = cursor;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> P.mCheckedItem = checkedItem;  </span><br><span class="line"> P.mLabelColumn = labelColumn;  </span><br><span class="line"> P.mIsSingleChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setSingleChoiceItems(CharSequence[] items, int checkedItem, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mItems = items;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> P.mCheckedItem = checkedItem;  </span><br><span class="line"> P.mIsSingleChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setSingleChoiceItems(ListAdapter adapter, int checkedItem, final OnClickListener listener) &#123;  </span><br><span class="line"> P.mAdapter = adapter;  </span><br><span class="line"> P.mOnClickListener = listener;  </span><br><span class="line"> P.mCheckedItem = checkedItem;  </span><br><span class="line"> P.mIsSingleChoice = true;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setOnItemSelectedListener(final AdapterView.OnItemSelectedListener listener) &#123;  </span><br><span class="line"> P.mOnItemSelectedListener = listener;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setView(int layoutResId) &#123;  </span><br><span class="line"> P.mView = null;  </span><br><span class="line"> P.mViewLayoutResId = layoutResId;  </span><br><span class="line"> P.mViewSpacingSpecified = false;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public Builder setView(View view) &#123;  </span><br><span class="line"> P.mView = view;  </span><br><span class="line"> P.mViewLayoutResId = 0;  </span><br><span class="line"> P.mViewSpacingSpecified = false;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> @Deprecated  </span><br><span class="line"> public Builder setView(View view, int viewSpacingLeft, int viewSpacingTop,  </span><br><span class="line"> int viewSpacingRight, int viewSpacingBottom) &#123;  </span><br><span class="line"> P.mView = view;  </span><br><span class="line"> P.mViewLayoutResId = 0;  </span><br><span class="line"> P.mViewSpacingSpecified = true;  </span><br><span class="line"> P.mViewSpacingLeft = viewSpacingLeft;  </span><br><span class="line"> P.mViewSpacingTop = viewSpacingTop;  </span><br><span class="line"> P.mViewSpacingRight = viewSpacingRight;  </span><br><span class="line"> P.mViewSpacingBottom = viewSpacingBottom;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> @Deprecated  </span><br><span class="line"> public Builder setInverseBackgroundForced(boolean useInverseBackground) &#123;  </span><br><span class="line"> P.mForceInverseBackground = useInverseBackground;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> /** </span><br><span class="line"> * @hide </span><br><span class="line"> */  </span><br><span class="line"> public Builder setRecycleOnMeasureEnabled(boolean enabled) &#123;  </span><br><span class="line"> P.mRecycleOnMeasure = enabled;  </span><br><span class="line"> return this;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public AlertDialog create() &#123;  </span><br><span class="line"> // Context has already been wrapped with the appropriate theme.  </span><br><span class="line"> final AlertDialog dialog = new AlertDialog(P.mContext, 0, false);  </span><br><span class="line"> P.apply(dialog.mAlert);  </span><br><span class="line"> dialog.setCancelable(P.mCancelable);  </span><br><span class="line"> if (P.mCancelable) &#123;  </span><br><span class="line"> dialog.setCanceledOnTouchOutside(true);  </span><br><span class="line"> &#125;  </span><br><span class="line"> dialog.setOnCancelListener(P.mOnCancelListener);  </span><br><span class="line"> dialog.setOnDismissListener(P.mOnDismissListener);  </span><br><span class="line"> if (P.mOnKeyListener != null) &#123;  </span><br><span class="line"> dialog.setOnKeyListener(P.mOnKeyListener);  </span><br><span class="line"> &#125;  </span><br><span class="line"> return dialog;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> public AlertDialog show() &#123;  </span><br><span class="line"> final AlertDialog dialog = create();  </span><br><span class="line"> dialog.show();  </span><br><span class="line"> return dialog;  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>在AlertDialog的Builder模式中并没有看到Director角色出现，其实在很多场景中，Android并没有完全按照经典模式实现来做，而是做了一些修改，使得这个模式更易于使用。</p>
<p>这里的AlertDialog.Builder同时扮演了上文中提到的builder、ConcreteBuilder、Director的角色，简化了Builder模式的设计。当模块比较稳定，不存在一些变化时，可以在经典模式实现的基础上做一些精简，而不是生搬硬套，使程序失去架构之美。正是由于灵活地运用设计模式，Android的源码很值得我们深入学习。 </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2017/01/17/Android消息机制底层原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/17/Android消息机制底层原理/" itemprop="url">
                  Android消息机制底层原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-17T20:44:28+08:00">
                2017-01-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/17/Android消息机制底层原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/17/Android消息机制底层原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h1><p>Android的消息机制主要是指Handler的运行机制，Handler的运行需要底层的MessageQueue和Looper的支撑。MessageQueue是消息队列。他的内存存储了一组消息，以队列的形式对外提供插入和删除的工作。他的内部存储结构并不是真正的队列，而是采用单链表的数据结构来存储消息列表。Looper为消息循环，由于MessageQueue只是一个消息的存储单元，它不能去处理消息，而Looper就填补了这个功能，Looper会以无限循环的形式去查找是否有新的消息，如果有的话就处理消息，否则就一直等待，Looper还有一个特殊的概念，那就是ThreadLocal，ThreadLocal并不是线程，它的作用可以在每个线程中存储数据。我们知道，Handler创建的时候会采用当前线程的Looper来构造消息循环系统，那么Handler内部如何获取到当前线程的Looper呢？这就要使用ThreadLocal了，ThreadLocal可以在不同的线程中互不干扰地存储并提供数据，通过ThreadLocal可以轻松获取每个线程的Looper。当然需要注意的是，线程是默认没有Looper的，如果需要使用Handler就必须为线程创建Looper。我们经常提到的主线程，也就是UI线程，它就是ActivityThread，ActivityThread被创建时会初始化Looper，这也是在主线程中默认可以使用Handler的原因。</p>
<p><img src="http://img.blog.csdn.net/20170117201927411?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="2-ThreadLocal-线程局部变量"><a href="#2-ThreadLocal-线程局部变量" class="headerlink" title="2.ThreadLocal-线程局部变量"></a>2.ThreadLocal-线程局部变量</h1><p>ThreadLocal是一个现场内部的数据存储类，通过它可以在指定的线程中存储数据，数据存储以后，只有在指定线程中可以获取到存储的数据。对于Handler来说，它需要获取当前线程的Looper，很显然Looper的作用域就是线程并且不同线程具有不同的Looper，这个时候通过ThreadLocal就可以轻松实现Looper在线程中的存储。ThreadLocal是一个泛型类。<br><img src="http://img.blog.csdn.net/20170117202844933?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h2 id="2-1存储机制"><a href="#2-1存储机制" class="headerlink" title="2.1存储机制"></a>2.1存储机制</h2><p>在localValues内部有一个数组；private Object[]table，ThreadLocal的值就存在这个table数组中，ThreadLocal的值在table数组中的存储位置总是为ThreadLocal的reference字段所标识的对象的下一个位置，比如ThreadLocal的reference对象在table数组中的索引为index，那么ThreadLocal的值在table数组中的索引就是index+1.最终ThreadLocal的值将会被存储在table数组中：table[index+1]=value</p>
<h2 id="2-put"><a href="#2-put" class="headerlink" title="2.put"></a>2.put</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> void put(ThreadLocal&lt;?&gt; key, Object value) &#123;  </span><br><span class="line">  cleanUp();  </span><br><span class="line">  </span><br><span class="line">  // Keep track of first tombstone. That&apos;s where we want to go back  </span><br><span class="line">  // and add an entry if necessary.  </span><br><span class="line">  int firstTombstone = -1;  </span><br><span class="line">  </span><br><span class="line">  for (int index = key.hash &amp; mask;; index = next(index)) &#123;  </span><br><span class="line">  Object k = table[index];  </span><br><span class="line">  </span><br><span class="line">  if (k == key.reference) &#123;  </span><br><span class="line">  // Replace existing entry.  </span><br><span class="line">  table[index + 1] = value;  </span><br><span class="line">  return;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  if (k == null) &#123;  </span><br><span class="line">  if (firstTombstone == -1) &#123;  </span><br><span class="line">  // Fill in null slot.  </span><br><span class="line">  table[index] = key.reference;  </span><br><span class="line">  table[index + 1] = value;  </span><br><span class="line">  size++;  </span><br><span class="line">  return;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  // Go back and replace first tombstone.  </span><br><span class="line">  table[firstTombstone] = key.reference;  </span><br><span class="line">  table[firstTombstone + 1] = value;  </span><br><span class="line">  tombstones--;  </span><br><span class="line">  size++;  </span><br><span class="line">  return;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  // Remember first tombstone.  </span><br><span class="line">  if (firstTombstone == -1 &amp;&amp; k == TOMBSTONE) &#123;  </span><br><span class="line">  firstTombstone = index;  </span><br><span class="line">  &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">//获取当前线程的数据  </span><br><span class="line">  Values values(Thread current) &#123;  </span><br><span class="line">  return current.localValues;//当前线程存储的数组  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">//初始化当前线程的数据  </span><br><span class="line">Values initializeValues(Thread current) &#123;  </span><br><span class="line">  return current.localValues = new Values();  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-set"><a href="#2-3-set" class="headerlink" title="2.3 set"></a>2.3 set</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public void set(T value) &#123;  </span><br><span class="line">Thread currentThread = Thread.currentThread();//获取当前的线程  </span><br><span class="line">Values values = values(currentThread);//  </span><br><span class="line">if (values == null) &#123;  </span><br><span class="line">values = initializeValues(currentThread);  </span><br><span class="line">&#125;  </span><br><span class="line">values.put(this, value);  </span><br><span class="line">&#125;  </span><br><span class="line">3）get</span><br><span class="line">[java] view plain copy 在CODE上查看代码片派生到我的代码片</span><br><span class="line">public T get() &#123;  </span><br><span class="line"> // Optimized for the fast path.  </span><br><span class="line"> Thread currentThread = Thread.currentThread();  </span><br><span class="line"> Values values = values(currentThread);  </span><br><span class="line"> if (values != null) &#123;  </span><br><span class="line"> Object[] table = values.table;  </span><br><span class="line"> int index = hash &amp; values.mask;  </span><br><span class="line"> if (this.reference == table[index]) &#123;  </span><br><span class="line"> return (T) table[index + 1];  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125; else &#123;  </span><br><span class="line"> values = initializeValues(currentThread);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> return (T) values.getAfterMiss(this);  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>从ThreadLocal的set和get方法可以看出，他们所操作的对象都是当前线程localValues对象的table数组，因此在不同线程中访问同一个ThreadLocal的set和get方法，他们对ThreadLocal所做的读写操作仅限于各自线程的内部。</p>
<h1 id="3-MessageQueue-消息队列"><a href="#3-MessageQueue-消息队列" class="headerlink" title="3.MessageQueue-消息队列"></a>3.MessageQueue-消息队列</h1><p>消息队列在Android中指的是MessageQueue，MessageQueue主要包含两个操作：插入和读取。读取操作本身会伴随着删除操作，插入和读取对应的方法分别为enqueueMessage和next，其中enqueueMessage的作用是往消息队列中 插入一条消息，而next的作用是从消息队列中取出一条消息并将其从消息队列中移除。MessageQueue内部是通过一个单链表的数据结构来维护消息列表，当链表在插入和删除上比较有优势。<br><img src="http://img.blog.csdn.net/20170117203122771?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h2 id="3-1enqueueMessage插入消息"><a href="#3-1enqueueMessage插入消息" class="headerlink" title="3.1enqueueMessage插入消息"></a>3.1enqueueMessage插入消息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">boolean enqueueMessage(Message msg, long when) &#123;  </span><br><span class="line">  if (msg.target == null) &#123;  </span><br><span class="line">  throw new IllegalArgumentException(&quot;Message must have a target.&quot;);  </span><br><span class="line">  &#125;  </span><br><span class="line">  if (msg.isInUse()) &#123;  </span><br><span class="line">  throw new IllegalStateException(msg + &quot; This message is already in use.&quot;);  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  synchronized (this) &#123;  </span><br><span class="line">  if (mQuitting) &#123;  </span><br><span class="line">  IllegalStateException e = new IllegalStateException(  </span><br><span class="line">  msg.target + &quot; sending message to a Handler on a dead thread&quot;);  </span><br><span class="line">  Log.w(TAG, e.getMessage(), e);  </span><br><span class="line">  msg.recycle();  </span><br><span class="line">  return false;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  msg.markInUse();  </span><br><span class="line">  msg.when = when;  </span><br><span class="line">  Message p = mMessages;  </span><br><span class="line">  boolean needWake;  </span><br><span class="line">  if (p == null || when == 0 || when &lt; p.when) &#123;  </span><br><span class="line">  // New head, wake up the event queue if blocked.  </span><br><span class="line">  msg.next = p;  </span><br><span class="line">  mMessages = msg;  </span><br><span class="line">  needWake = mBlocked;  </span><br><span class="line">  &#125; else &#123;  </span><br><span class="line">  // Inserted within the middle of the queue. Usually we don&apos;t have to wake  </span><br><span class="line">  // up the event queue unless there is a barrier at the head of the queue  </span><br><span class="line">  // and the message is the earliest asynchronous message in the queue.  </span><br><span class="line">  needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous();  </span><br><span class="line">  Message prev;  </span><br><span class="line">  for (;;) &#123;  </span><br><span class="line">  prev = p;  </span><br><span class="line">  p = p.next;  </span><br><span class="line">  if (p == null || when &lt; p.when) &#123;  </span><br><span class="line">  break;  </span><br><span class="line">  &#125;  </span><br><span class="line">  if (needWake &amp;&amp; p.isAsynchronous()) &#123;  </span><br><span class="line">  needWake = false;  </span><br><span class="line">  &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  msg.next = p; // invariant: p == prev.next  </span><br><span class="line">  prev.next = msg;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  // We can assume mPtr != 0 because mQuitting is false.  </span><br><span class="line">  if (needWake) &#123;  </span><br><span class="line">  nativeWake(mPtr);  </span><br><span class="line">  &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  return true;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-next获取消息"><a href="#3-2-next获取消息" class="headerlink" title="3.2 next获取消息"></a>3.2 next获取消息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">Message next() &#123;  </span><br><span class="line">// Return here if the message loop has already quit and been disposed.  </span><br><span class="line">// This can happen if the application tries to restart a looper after quit  </span><br><span class="line">// which is not supported.  </span><br><span class="line">final long ptr = mPtr;  </span><br><span class="line">if (ptr == 0) &#123;  </span><br><span class="line">return null;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">int pendingIdleHandlerCount = -1; // -1 only during first iteration  </span><br><span class="line">int nextPollTimeoutMillis = 0;  </span><br><span class="line">for (;;) &#123;  </span><br><span class="line">if (nextPollTimeoutMillis != 0) &#123;  </span><br><span class="line">Binder.flushPendingCommands();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">nativePollOnce(ptr, nextPollTimeoutMillis);  </span><br><span class="line">  </span><br><span class="line">synchronized (this) &#123;  </span><br><span class="line">// Try to retrieve the next message. Return if found.  </span><br><span class="line">final long now = SystemClock.uptimeMillis();  </span><br><span class="line">Message prevMsg = null;  </span><br><span class="line">Message msg = mMessages;  </span><br><span class="line">if (msg != null &amp;&amp; msg.target == null) &#123;  </span><br><span class="line">// Stalled by a barrier. Find the next asynchronous message in the queue.  </span><br><span class="line">do &#123;  </span><br><span class="line">prevMsg = msg;  </span><br><span class="line">msg = msg.next;  </span><br><span class="line">&#125; while (msg != null &amp;&amp; !msg.isAsynchronous());  </span><br><span class="line">&#125;  </span><br><span class="line">if (msg != null) &#123;  </span><br><span class="line">if (now &lt; msg.when) &#123;  </span><br><span class="line">// Next message is not ready. Set a timeout to wake up when it is ready.  </span><br><span class="line">nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">// Got a message.  </span><br><span class="line">mBlocked = false;  </span><br><span class="line">if (prevMsg != null) &#123;  </span><br><span class="line">prevMsg.next = msg.next;  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">mMessages = msg.next;  </span><br><span class="line">&#125;  </span><br><span class="line">msg.next = null;  </span><br><span class="line">if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg);  </span><br><span class="line">msg.markInUse();  </span><br><span class="line">return msg;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">// No more messages.  </span><br><span class="line">nextPollTimeoutMillis = -1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// Process the quit message now that all pending messages have been handled.  </span><br><span class="line">if (mQuitting) &#123;  </span><br><span class="line">dispose();  </span><br><span class="line">return null;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// If first time idle, then get the number of idlers to run.  </span><br><span class="line">// Idle handles only run if the queue is empty or if the first message  </span><br><span class="line">// in the queue (possibly a barrier) is due to be handled in the future.  </span><br><span class="line">if (pendingIdleHandlerCount &lt; 0  </span><br><span class="line">&amp;&amp; (mMessages == null || now &lt; mMessages.when)) &#123;  </span><br><span class="line">pendingIdleHandlerCount = mIdleHandlers.size();  </span><br><span class="line">&#125;  </span><br><span class="line">if (pendingIdleHandlerCount &lt;= 0) &#123;  </span><br><span class="line">// No idle handlers to run. Loop and wait some more.  </span><br><span class="line">mBlocked = true;  </span><br><span class="line">continue;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">if (mPendingIdleHandlers == null) &#123;  </span><br><span class="line">mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];  </span><br><span class="line">&#125;  </span><br><span class="line">mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// Run the idle handlers.  </span><br><span class="line">// We only ever reach this code block during the first iteration.  </span><br><span class="line">for (int i = 0; i &lt; pendingIdleHandlerCount; i++) &#123;  </span><br><span class="line">final IdleHandler idler = mPendingIdleHandlers[i];  </span><br><span class="line">mPendingIdleHandlers[i] = null; // release the reference to the handler  </span><br><span class="line">  </span><br><span class="line">boolean keep = false;  </span><br><span class="line">try &#123;  </span><br><span class="line">keep = idler.queueIdle();  </span><br><span class="line">&#125; catch (Throwable t) &#123;  </span><br><span class="line">Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">if (!keep) &#123;  </span><br><span class="line">synchronized (this) &#123;  </span><br><span class="line">mIdleHandlers.remove(idler);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// Reset the idle handler count to 0 so we do not run them again.  </span><br><span class="line">pendingIdleHandlerCount = 0;  </span><br><span class="line">  </span><br><span class="line">// While calling an idle handler, a new message could have been delivered  </span><br><span class="line">// so go back and look again for a pending message without waiting.  </span><br><span class="line">nextPollTimeoutMillis = 0;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>next方法是一个无限循环的方法，如果消息队列中没有消息，那么next方法会一直堵塞在这里。当有新消息到来时，next方法会返回这条消息并将其从链表中移除</p>
<h1 id="4-Message-消息实体"><a href="#4-Message-消息实体" class="headerlink" title="4.Message- 消息实体"></a>4.Message- 消息实体</h1><p>需要注意Message的一些成员变量<br> Handler target;  //对应的Handler<br> Runnable callback; //对应的回调<br>Message next;//单链表引用</p>
<p><img src="http://img.blog.csdn.net/20170117203304149?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h1 id="5-Looper-消息循环"><a href="#5-Looper-消息循环" class="headerlink" title="5.Looper-消息循环"></a>5.Looper-消息循环</h1><p>Looper在Android的消息机制中扮演着消息循环的角色，具体来说就是他会不停地从MessageQueue中查看是否有新消息，如果有新消息就会立刻处理，否则就一直阻塞在哪里。<br><img src="http://img.blog.csdn.net/20170117203344134?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt><br>Looper处理prepare方法外，还提供了prepareMainLooper方法，这个方法主要是给主线程也就是ActivityThread创建Looper使用的，其本质也是通过prepare方法来实现。由于主线程的Looper比较特殊，所以Looper提供一个getMainLooper方法，通过它可以在任何地方获取主线程的Looper。Looper也是可以退出的，Looper提供勒quit和quitSafely来退出一个Looper。quit会直接退出Looper，而quitSafely只是设定一个退出标记，然后把消息队列的已有消息处理完毕后才安全退出。Looper退出后，通过Handler发送的消息会失败，这个时候Handler的send方法会返回false。在子线程，如果手动为其创建了Looper，那么所有的事情完成以后应该调用quit方法来终止消息循环，否则这个子线程就会一直处理等待的状态。<br>Looper最重要的一个方法是Loop方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public static void loop() &#123;  </span><br><span class="line">final Looper me = myLooper();  </span><br><span class="line">if (me == null) &#123;  </span><br><span class="line">throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;);  </span><br><span class="line">&#125;  </span><br><span class="line">final MessageQueue queue = me.mQueue;  </span><br><span class="line">  </span><br><span class="line">// Make sure the identity of this thread is that of the local process,  </span><br><span class="line">// and keep track of what that identity token actually is.  </span><br><span class="line">Binder.clearCallingIdentity();  </span><br><span class="line">final long ident = Binder.clearCallingIdentity();  </span><br><span class="line">  </span><br><span class="line">for (;;) &#123;  </span><br><span class="line">Message msg = queue.next(); // might block  </span><br><span class="line">if (msg == null) &#123;  </span><br><span class="line">// No message indicates that the message queue is quitting.  </span><br><span class="line">return;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// This must be in a local variable, in case a UI event sets the logger  </span><br><span class="line">Printer logging = me.mLogging;  </span><br><span class="line">if (logging != null) &#123;  </span><br><span class="line">logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; +  </span><br><span class="line">msg.callback + &quot;: &quot; + msg.what);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">msg.target.dispatchMessage(msg);  </span><br><span class="line">  </span><br><span class="line">if (logging != null) &#123;  </span><br><span class="line">logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// Make sure that during the course of dispatching the  </span><br><span class="line">// identity of the thread wasn&apos;t corrupted.  </span><br><span class="line">final long newIdent = Binder.clearCallingIdentity();  </span><br><span class="line">if (ident != newIdent) &#123;  </span><br><span class="line">Log.wtf(TAG, &quot;Thread identity changed from 0x&quot;  </span><br><span class="line">+ Long.toHexString(ident) + &quot; to 0x&quot;  </span><br><span class="line">+ Long.toHexString(newIdent) + &quot; while dispatching to &quot;  </span><br><span class="line">+ msg.target.getClass().getName() + &quot; &quot;  </span><br><span class="line">+ msg.callback + &quot; what=&quot; + msg.what);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">msg.recycleUnchecked();  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loop方法是一个死循环，唯一跳出循环的方式是MessageQueue的next方法返回了null。当Looper的quit方法被调用时，Looper就会调用MessageQueue的quit或者quitSafely方法来通知消息队列退出，当消息队列被标记为退出状态时，他的next方法会返回null。loop方法会调用MessageQueue的next方法来获取新消息，而next是一个阻塞操作，当没有消息时，next方法会一直阻塞在哪里，这也导致loop方法一直阻塞在哪里。若有新消息，Looper会调用msg。target。dispatchMessage（msg），这里的msg.target是发送这条消息的Handler对象，这样Handler发送的消息最终又交给它的dispatchMessage方法来处理了。但是这里不同的是，Handler的dispatchMessage方法是在创建Handler时所使用的Looper中执行，这样就成功将代码逻辑切换到指定的线程中去执行了。</p>
<h1 id="6-Handle-消息处理"><a href="#6-Handle-消息处理" class="headerlink" title="6.Handle-消息处理"></a>6.Handle-消息处理</h1><p>Handler的工作主要包含消息的发送和接收过程。消息的发送可以通过post的一系列方法以及send的一系列方法来实现，post的一系列方法最终是通过send的一系列方法来实现的。<br><img src="http://img.blog.csdn.net/20170117203435091?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvanVuYmluMTAxMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt></p>
<h2 id="6-1-创建"><a href="#6-1-创建" class="headerlink" title="6.1 创建"></a>6.1 创建</h2><p>使用Handler必须要有Looper，不然会报异常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public Handler(Callback callback) &#123;  </span><br><span class="line">  this(callback, false);  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  /** </span><br><span class="line">  * Use the provided &#123;@link Looper&#125; instead of the default one. </span><br><span class="line">  * </span><br><span class="line">  * @param looper The looper, must not be null. </span><br><span class="line">  */  </span><br><span class="line">  public Handler(Looper looper) &#123;  </span><br><span class="line">  this(looper, null, false);  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  public Handler(Callback callback, boolean async) &#123;  </span><br><span class="line">  if (FIND_POTENTIAL_LEAKS) &#123;  </span><br><span class="line">  final Class&lt;? extends Handler&gt; klass = getClass();  </span><br><span class="line">  if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;  </span><br><span class="line">  (klass.getModifiers() &amp; Modifier.STATIC) == 0) &#123;  </span><br><span class="line">  Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; +  </span><br><span class="line">  klass.getCanonicalName());  </span><br><span class="line">  &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  mLooper = Looper.myLooper();  </span><br><span class="line">  if (mLooper == null) &#123;  </span><br><span class="line">  throw new RuntimeException(  </span><br><span class="line">  &quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;);  </span><br><span class="line">  &#125;  </span><br><span class="line">  mQueue = mLooper.mQueue;  </span><br><span class="line">  mCallback = callback;  </span><br><span class="line">  mAsynchronous = async;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="6-2-发送"><a href="#6-2-发送" class="headerlink" title="6.2 发送"></a>6.2 发送</h2><p>Handler发送消息的过程仅仅是向消息队列中插入了一条消息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public boolean sendMessageAtTime(Message msg, long uptimeMillis) &#123;  </span><br><span class="line"> MessageQueue queue = mQueue;  </span><br><span class="line"> if (queue == null) &#123;  </span><br><span class="line"> RuntimeException e = new RuntimeException(  </span><br><span class="line"> this + &quot; sendMessageAtTime() called with no mQueue&quot;);  </span><br><span class="line"> Log.w(&quot;Looper&quot;, e.getMessage(), e);  </span><br><span class="line"> return false;  </span><br><span class="line"> &#125;  </span><br><span class="line"> return enqueueMessage(queue, msg, uptimeMillis);  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="6-3-接收"><a href="#6-3-接收" class="headerlink" title="6.3 接收"></a>6.3 接收</h2><p> 当消息队列插入消息后，MessageQueue的next方法就会返回这条消息给Looper，Looper收到消息后就开始处理了，最终消息由Looper交由Handler处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public interface Callback &#123;  </span><br><span class="line"> public boolean handleMessage(Message msg);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> /** </span><br><span class="line"> * Subclasses must implement this to receive messages. </span><br><span class="line"> */  </span><br><span class="line"> public void handleMessage(Message msg) &#123;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> /** </span><br><span class="line"> * Handle system messages here. </span><br><span class="line"> */  </span><br><span class="line"> public void dispatchMessage(Message msg) &#123;  </span><br><span class="line"> if (msg.callback != null) &#123;  </span><br><span class="line"> handleCallback(msg);  </span><br><span class="line"> &#125; else &#123;  </span><br><span class="line"> if (mCallback != null) &#123;  </span><br><span class="line"> if (mCallback.handleMessage(msg)) &#123;  </span><br><span class="line"> return;  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line"> handleMessage(msg);  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="7-主线程的消息循环"><a href="#7-主线程的消息循环" class="headerlink" title="7.主线程的消息循环"></a>7.主线程的消息循环</h1><p>Android的主线程就是ActivityThread，主线程的入口方法为main，在main方法中系统会通过Looper.prepareMainLooper()来创建主线程的Looper以及MessageQueue，并通过Looper。loop（）来开启主线程的消息循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;  </span><br><span class="line"> Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ActivityThreadMain&quot;);  </span><br><span class="line"> SamplingProfilerIntegration.start();  </span><br><span class="line">  </span><br><span class="line"> // CloseGuard defaults to true and can be quite spammy. We  </span><br><span class="line"> // disable it here, but selectively enable it later (via  </span><br><span class="line"> // StrictMode) on debug builds, but using DropBox, not logs.  </span><br><span class="line"> CloseGuard.setEnabled(false);  </span><br><span class="line">  </span><br><span class="line"> Environment.initForCurrentUser();  </span><br><span class="line">  </span><br><span class="line"> // Set the reporter for event logging in libcore  </span><br><span class="line"> EventLogger.setReporter(new EventLoggingReporter());  </span><br><span class="line">  </span><br><span class="line"> AndroidKeyStoreProvider.install();  </span><br><span class="line">  </span><br><span class="line"> // Make sure TrustedCertificateStore looks in the right place for CA certificates  </span><br><span class="line"> final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());  </span><br><span class="line"> TrustedCertificateStore.setDefaultUserDirectory(configDir);  </span><br><span class="line">  </span><br><span class="line"> Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);  </span><br><span class="line">  </span><br><span class="line"> Looper.prepareMainLooper();  </span><br><span class="line">  </span><br><span class="line"> ActivityThread thread = new ActivityThread();  </span><br><span class="line"> thread.attach(false);  </span><br><span class="line">  </span><br><span class="line"> if (sMainThreadHandler == null) &#123;  </span><br><span class="line"> sMainThreadHandler = thread.getHandler();  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> if (false) &#123;  </span><br><span class="line"> Looper.myLooper().setMessageLogging(new  </span><br><span class="line"> LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;));  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> // End of event ActivityThreadMain.  </span><br><span class="line"> Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);  </span><br><span class="line"> Looper.loop();  </span><br><span class="line">  </span><br><span class="line"> throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>主线程的消息循环开始以后，ActivityThread还需要一个Handler来和消息队列进行交互，这个Handler就是ActivityThread.H，他的内部定义了一组消息类型，主要管理Activity的生命周期及四大组件的启动和停止过程等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> private class H extends Handler &#123;  </span><br><span class="line">  public static final int LAUNCH_ACTIVITY = 100;  </span><br><span class="line">  public static final int PAUSE_ACTIVITY = 101;  </span><br><span class="line">  public static final int PAUSE_ACTIVITY_FINISHING= 102;  </span><br><span class="line">  public static final int STOP_ACTIVITY_SHOW = 103;  </span><br><span class="line">  public static final int STOP_ACTIVITY_HIDE = 104;  </span><br><span class="line">  public static final int SHOW_WINDOW = 105;  </span><br><span class="line">  public static final int HIDE_WINDOW = 106;  </span><br><span class="line">  public static final int RESUME_ACTIVITY = 107;  </span><br><span class="line">  public static final int SEND_RESULT = 108;  </span><br><span class="line">  public static final int DESTROY_ACTIVITY = 109;  </span><br><span class="line">  public static final int BIND_APPLICATION = 110;  </span><br><span class="line">  public static final int EXIT_APPLICATION = 111;  </span><br><span class="line">  public static final int NEW_INTENT = 112;  </span><br><span class="line">  public static final int RECEIVER = 113;  </span><br><span class="line">  public static final int CREATE_SERVICE = 114;  </span><br><span class="line">  public static final int SERVICE_ARGS = 115;  </span><br><span class="line">  public static final int STOP_SERVICE = 116;  </span><br><span class="line">  </span><br><span class="line">  public static final int CONFIGURATION_CHANGED = 118;  </span><br><span class="line">  public static final int CLEAN_UP_CONTEXT = 119;  </span><br><span class="line">  public static final int GC_WHEN_IDLE = 120;  </span><br><span class="line">  public static final int BIND_SERVICE = 121;  </span><br><span class="line">  public static final int UNBIND_SERVICE = 122;  </span><br><span class="line">  public static final int DUMP_SERVICE = 123;  </span><br><span class="line">  public static final int LOW_MEMORY = 124;  </span><br><span class="line">  public static final int ACTIVITY_CONFIGURATION_CHANGED = 125;  </span><br><span class="line">  public static final int RELAUNCH_ACTIVITY = 126;  </span><br><span class="line">  public static final int PROFILER_CONTROL = 127;  </span><br><span class="line">  public static final int CREATE_BACKUP_AGENT = 128;  </span><br><span class="line">  public static final int DESTROY_BACKUP_AGENT = 129;  </span><br><span class="line">  public static final int SUICIDE = 130;  </span><br><span class="line">  public static final int REMOVE_PROVIDER = 131;  </span><br><span class="line">  public static final int ENABLE_JIT = 132;  </span><br><span class="line">  public static final int DISPATCH_PACKAGE_BROADCAST = 133;  </span><br><span class="line">  public static final int SCHEDULE_CRASH = 134;  </span><br><span class="line">  public static final int DUMP_HEAP = 135;  </span><br><span class="line">  public static final int DUMP_ACTIVITY = 136;  </span><br><span class="line">  public static final int SLEEPING = 137;  </span><br><span class="line">  public static final int SET_CORE_SETTINGS = 138;  </span><br><span class="line">  public static final int UPDATE_PACKAGE_COMPATIBILITY_INFO = 139;  </span><br><span class="line">  public static final int TRIM_MEMORY = 140;  </span><br><span class="line">  public static final int DUMP_PROVIDER = 141;  </span><br><span class="line">  public static final int UNSTABLE_PROVIDER_DIED = 142;  </span><br><span class="line">  public static final int REQUEST_ASSIST_CONTEXT_EXTRAS = 143;  </span><br><span class="line">  public static final int TRANSLUCENT_CONVERSION_COMPLETE = 144;  </span><br><span class="line">  public static final int INSTALL_PROVIDER = 145;  </span><br><span class="line">  public static final int ON_NEW_ACTIVITY_OPTIONS = 146;  </span><br><span class="line">  public static final int CANCEL_VISIBLE_BEHIND = 147;  </span><br><span class="line">  public static final int BACKGROUND_VISIBLE_BEHIND_CHANGED = 148;  </span><br><span class="line">  public static final int ENTER_ANIMATION_COMPLETE = 149;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外经常使用的runOnUIThread(Runable action),通过源码分析也是使用了mHandler，而mHandler的Looper也是使用的UI线程的mainLooper。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final void runOnUiThread(Runnable action) &#123;  </span><br><span class="line">      if (Thread.currentThread() != mUiThread) &#123;  </span><br><span class="line">          mHandler.post(action);  </span><br><span class="line">      &#125; else &#123;  </span><br><span class="line">          action.run();  </span><br><span class="line">      &#125;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f" alt="黄俊彬">
          <p class="site-author-name" itemprop="name">黄俊彬</p>
           
              <p class="site-description motion-element" itemprop="description">一花一世界，一码一浮生</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">80</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/junbin1011" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄俊彬</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"junbin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
